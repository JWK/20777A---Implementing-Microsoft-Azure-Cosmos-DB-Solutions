# Lab Answer Key: Module 3: Implementing Server-Side Operations

- [Lab Answer Key: Module 3: Implementing Server-Side Operations](#lab-answer-key-module-3-implementing-server-side-operations)
  - [Lab: Writing User-Defined Functions, Stored Procedures and Triggers](#lab-writing-user-defined-functions-stored-procedures-and-triggers)
    - [Exercise 1: Redesigning the Document Structure and Partitioning Strategy](#exercise-1-redesigning-the-document-structure-and-partitioning-strategy)
      - [Task 1: Prepare the Environment](#task-1-prepare-the-environment)
      - [Task 2: Analyze the Technical Requirements for Document Partitioning](#task-2-analyze-the-technical-requirements-for-document-partitioning)
      - [Task 3: Implement the Different Types of Documents](#task-3-implement-the-different-types-of-documents)
      - [Task 4: Create a Document Database Using the Cosmos DB SQL API](#task-4-create-a-document-database-using-the-cosmos-db-sql-api)
      - [Task 5: Import the Product and Customer Data](#task-5-import-the-product-and-customer-data)
    - [Exercise 2: Implementing the Shopping Cart Functionality](#exercise-2-implementing-the-shopping-cart-functionality)
      - [Task 1: Configure the Repository Classes](#task-1-configure-the-repository-classes)
      - [Task 2: Complete the Customer Controller to Enable Customers to Login and Logout](#task-2-complete-the-customer-controller-to-enable-customers-to-login-and-logout)
      - [Task 3: Implement Functionality to Add Items to the Shopping Cart](#task-3-implement-functionality-to-add-items-to-the-shopping-cart)
    - [Exercise 3: Creating Orders and Backorders](#exercise-3-creating-orders-and-backorders)
      - [Task 1: Create the CheckStockAvailable Stored Procedure](#task-1-create-the-checkstockavailable-stored-procedure)
      - [Task 2: Test the CheckStockAvailable Stored Procedure](#task-2-test-the-checkstockavailable-stored-procedure)
      - [Task 3: Add Stored Procedure Functionality to the Repository](#task-3-add-stored-procedure-functionality-to-the-repository)
      - [Task 4: Call the CheckStockAvailable Stored Procedure From the App Using the Repository](#task-4-call-the-checkstockavailable-stored-procedure-from-the-app-using-the-repository)
    - [Exercise 4: Maintaining Data and Auditing Orders and Backorders](#exercise-4-maintaining-data-and-auditing-orders-and-backorders)
      - [Task 2: Create a Post-trigger that Audits Changes Made to Orders and Backorders](#task-2-create-a-post-trigger-that-audits-changes-made-to-orders-and-backorders)
      - [Task 3: Add Trigger Functionality to the Repository](#task-3-add-trigger-functionality-to-the-repository)
      - [Task 4: Invoke the Triggers](#task-4-invoke-the-triggers)
      - [Task 5: Lab Close Down](#task-5-lab-close-down)

## Lab: Writing User-Defined Functions, Stored Procedures and Triggers

### Exercise 1: Redesigning the Document Structure and Partitioning Strategy

#### Task 1: Prepare the Environment

1.  Ensure that the **MT17B-WS2016-NAT** and **20777A-LON-DEV** virtual machines are running, and then log on to **20777A-LON-DEV** as **Administrator** with the password **Pa55w.rd**.

2.  On the toolbar, click **File Explorer**.

3.  In File Explorer, navigate to **E:\\Labfiles\\Lab03\\Starter**, right-click **Setup.cmd**, and then click **Run as administrator**.

4.  Wait for the script to finish.

5.  On the toolbar, click **Internet Explorer**.

6.  In Internet Explorer, go to **http://portal.azure.com**, and sign in using the Microsoft account that is associated with your Azure Learning Pass subscription.

7.  In the Azure Portal, click **+ Create a resource**.

8.  On the **New** blade, in the search box, type **storage account**, and then press Enter.

9.  On the **Everything** blade, click **Storage account - blob, file, table, queue**.

10. On the **Storage account - blob, file, table, queue** blade, click **Create**.

11. On the **Create storage account** blade, under the **Resource group** box, click **Create new**, type **20777\_Mod03**, and then click **OK**.

12. In the **Storage account name** box, type **20777blob\<*your name\>\<the day*\>**, for example, **20777blobjohn31**.

13. In the **Location** drop-down list, click the region closest to your current location.

14. In the **Account kind** list, click **BlobStorage**.

15. In the **Replication** list, click **Locally-redundant storage (LRS)**.

16. Click **Review + create**, and then click **Create**. 

17. In the Azure Portal, click **All resources**, and then click **20777blob\<*your name\>\<the day*\>**.

18. On the **20777blob\<*your name\>\<the day*\>** blade, under **Blob Service**, click **Blobs**.

19. On the **Blobs** blade, click **+ Container**.

20. In the **New container** dialog box, in the **Name** box, type **20777-mod3-blobs**.

21. In the **Public access level** drop-down list, click **Blob (anonymous read access for blobs only)**, and then click **OK**.

22. On the **20777blob\<*your name\>\<the day*\>** blade, under **Settings**, click **Access keys**.

23. Under **key1**, make a note of the **Connection string** value.

24. In the left pane of the Azure portal, click **+ Create a resource**.

25. On the **New** blade, in the search box, type **Cosmos DB**, and then press Enter.

26. On the **Everything** blade, click **Azure Cosmos DB**, and then click **Create**.

27. On the **Azure Cosmos DB** blade, in the **Resource Group**, drop-down list, click **20777\_Mod03**. 

28. In the **Account name** box, type **20777-sql-\<*your name\>-\<the day*\>**, for example, **20777-sql-john-31**.

29. In the **API** drop-down list, click **Core (SQL)**.

30. In the **Location** drop-down list, click the region closest to your current location.

31. Click **Review + create**, and then click **Create**.

32. Wait for the Azure Cosmos DB to be createdâ€”this could take a few minutes.

33. In the Azure Portal, click **All resources**, and then click **20777-sql-\<*your name\>-\<the day*\>**.

34. On the **20777-sql-\<*your name\>-\<the day*\>** blade, click **Data Explorer**.

35. In the **SQL API** pane, click **New Database**.

36. On the **New Database** blade, in the **Database id** box, type **Adventure-Works**, and then click **OK**.

37. On the **20777a-sql-\<*your name\>-\<the day*\>** blade, under **Settings**, click **Keys**.

38. Make a note of the **URI**, and **PRIMARY KEY** values.

#### Task 2: Analyze the Technical Requirements for Document Partitioning

No detailed steps for this task. Read the description for the task in **20777A\_LAB\_03.md**.

#### Task 3: Implement the Different Types of Documents

1.  On the Start menu, click **Visual Studio 2017**.

2.  On the **File** menu, point to **Open**, and then click **Project/Solution**.

3.  In the **Open Project** dialog box, in the **File name** box, type **E:\\Labfiles\\Lab03\\Starter\\Exercise01\\Adventure-Works\\Adventure-Works.sln**, and then click **Open**.

4.  In the **Security Warning for Adventure-Works** dialog box, clear the **Ask me for every project in this solution** check box, click **OK**.

5.  In Solution Explorer, double-click **Web.config**.

6.  In App.config, in the **Value** attribute of the **EndpointUrl** key, paste the **URI** value you noted earlier, replacing the text **\<URL\>**.

7.  In the **Value** attribute of the **PrimaryKey** key, paste the **PRIMARY KEY** value you noted earlier, replacing the text **\<PRIMARY KEY\>**.

8.  In Solution Explorer, expand **Models**, and then double-click **DocumentType.cs**.

9.  In DocumentType.cs, after the comment **// TODO: doctype distinguishes the different types of documents in the same collection**, type the following code:
    ```csharp
    [JsonProperty("doctype")]
    public string DocType { get; set; }
    ```
10. After the comment **// TODO: Initialize the doctype property**, type the following code:
    ```csharp
    this.DocType = this.GetType().Name;
    ```
11. After the comment **// TODO: ttl of document. By default, ttl is disabled, but can be changed by setting it to a positive integer value (number of seconds)**, type the following code:
    ```csharp
    [JsonProperty("ttl")]
    public int TimeToLive { get; set; } = -1;
    ```
12. In Solution Explorer, under **Models**, double-click **Customer.cs**.

13. In Customer.cs, replace:
    ```csharp
    public class CustomerName
    {
        // TODO: Define properties

    }
    ```

    with:

    ```csharp
    public class CustomerName
    {
        [JsonProperty("title")]
        public string Title { get; set; }
    
        [JsonProperty("firstname")]
        public string FirstName { get; set; }
    
        [JsonProperty("middlename")]
        public string MiddleName { get; set; }
    
        [JsonProperty("lastname")]
        public string LastName { get; set; }
    }
    ```

14. In Customer.cs, replace:
    ```csharp
    public class Customer : DocumentType
    {
        // TODO: Define properties
    
    }
    ```
    with:

    ```csharp
    public class Customer : DocumentType
    {
        [JsonProperty("partitionkey")]
        public string CustomerID { get; set; }

        [JsonProperty("name")]
        public CustomerName CustomerName { get; set; }

        [JsonProperty("discountrate")]
        public int DiscountRate { get; set; }
    }
    ```
15. In Solution Explorer, under **Models**, double-click **ShoppingCartOrder.cs**.

16. In ShoppingCartOrder.cs, replace:
    ```csharp
    public class OrderItem
    {
        // TODO: Define properties
    }
    ```
    
    with:

    ```csharp
    public class OrderItem
    {
        [JsonProperty("productnumber")]
        public string ProductNumber { get; set; }

        [JsonProperty("productname")]
        public string ProductName { get; set; }

        [JsonProperty("productid")]
        public string ProductID { get; set; }

        [JsonProperty("subcategory")]
        public string Subcategory { get; set; }

        [JsonProperty("numberincartorordered")]
        public int NumberInCartOrOrdered { get; set; }

        [JsonProperty("numberonbackorder")]
        public int NumberOnBackorder { get; set; }

        [JsonProperty("backorderreference")]
        public string BackorderReference { get; set; }

        [JsonProperty("unitcost")]
        public decimal UnitCost { get; set; }

        [JsonProperty("lineitemtotalcost")]
        public decimal LineItemTotalCost { get; set; }
    }
    ```
17. In ShoppingCartOrder.cs, replace:
    ```csharp
    public class ShoppingCartOrder : DocumentType
    {
        // TODO: Define properties
    }
    ```
    with:

    ```csharp
    public class ShoppingCartOrder : DocumentType
    {
        [JsonProperty("id")]
        public string ShoppingCartOrderID { get; set; }

        [JsonProperty("partitionkey")]
        public string CustomerID { get; set; }

        [JsonProperty("isshoppingcartororder")]
        public string IsShoppingCartOrOrder { get; set; }

        [JsonProperty("orderitems")]
        public List<OrderItem> OrderItems { get; set; }

        [JsonProperty("numberofitems")]
        public int NumberOfItems { get; set; }

        [JsonProperty("itemscost")]
        public decimal ItemsCost { get; set; }

        [JsonProperty("customerdiscountrate")]
        public int CustomerDiscountRate { get; set; } // Indicates % discount

        [JsonProperty("totalcost")]
        public decimal TotalCost { get; set; }

        [JsonProperty("dateplaced")]
        public long DatePlaced { get; set; } // Stored as ticks

        [JsonProperty("orderstatus")]
        public string OrderStatus { get; set; } // "In progress", "Delivered", "Cancelled"

        [JsonProperty("lastupdated")]
        public long LastUpdated { get; set; } // Also stored as ticks
    }
    ```
#### Task 4: Create a Document Database Using the Cosmos DB SQL API

1.  In Internet Explorer, in the Azure Portal, on the **20777-sql-\<*your name\>-\<the day*\>** blade, click **Data Explorer**.

2.  In the **SQL API** pane, right-click **Adventure-Works**, and then click **New Collection**.

3.  On the **Add Collection** blade, in the **Collection id** box, type **Data**.

4.  In the **Partition key** box, type **/partitionkey**.

5.  In the **Throughput (400 - 1,000,000 RU/s)** box, type **1000**, and then click **OK**.

6.  In Visual Studio, press F5 to run and start the application.

7.  In Internet Explorer, verify that the **Adventure-Works Product Catalog** page is displayed.

8.  Close the Adventure-Works Product Catalog page to stop the application.

9.  Close Visual Studio 2015.

#### Task 5: Import the Product and Customer Data

1.  On the Start menu, click **Visual Studio 2017**.

2.  On the **File** menu, point to **Open**, and then click **Project/Solution**.

3.  In the **Open Project** dialog box, in the **File name** box, type **E:\\Labfiles\\Lab03\\Starter\\Exercise01\\MigrateProductData\\MigrateProductData.sln**, and then click **Open**.

4.  In the **Security Warning for Adventure-Works** dialog box, clear the **Ask me for every project in this solution** check box, click **OK**.

5.  In Solution Explorer, double-click **App.config**.

6.  In App.config, in the **Value** attribute of the **EndpointUrl** key, paste the **URI** value you noted earlier, replacing the text \<**URL**\>.

7.  In the **Value** attribute of the **PrimaryKey** key, paste the **PRIMARY KEY** value you noted earlier, replacing the text **\<PRIMARY KEY\>**.

8.  In the **Value** attribute of the **BlobStorageConnectionString** key, paste the **Connection string** value you noted earlier, replacing the text **\<CONNECTION STRING\>**.

9.  In the **Value** attribute of the **BlobContainer** key, delete the text **\<BLOB CONTAINER NAME\>**, and then type **20777-mod3-blobs**.

10. Press F5 to run the application. Verify that it retrieves the data from SQL Server and uploads the documents to Cosmos DB without reporting any errors.

11. When the application finishes, close Visual Studio.

12. In Internet Explorer, in the **SQL API** pane, expand **Adventure-Works**, expand **Data**, and then click **Documents**.

13. On the **Documents** tab, click on one of the documents in the list to view it.

14. In the **SQL API** pane, click **Upload**.

15. On the **Upload Documents** blade, click the folder icon.

16. In the **Choose File to Upload** dialog box, in the **File name** box, type **E:\\Labfiles\\Lab03\\Data\\categories.json**, and then click **Open**.

17. On the **Upload Documents** blade, click **Upload**.

18. Wait for the upload to complete; the result message will report that **38 documents created**.

19. On the **Upload Documents** blade, click the folder icon.

20. In the **Choose File to Upload** dialog box, in the **File name** box, type **E:\\Labfiles\\Lab03\\Data\\customers.json**, and then click **Open**.

21. On the **Upload Documents** blade, click **Upload**.

22. Wait for the upload to complete; the result message will report that **100 documents created**.

23. Close the **Upload Documents** blade.

24. Close Visual Studio 2015.

### Exercise 2: Implementing the Shopping Cart Functionality

#### Task 1: Configure the Repository Classes

1.  On the Start menu, click **Visual Studio 2017**.

2.  On the **File** menu, point to **Open**, and then click **Project/Solution**.

3.  In the **Open Project** dialog box, in the **File name** box, type **E:\\Labfiles\\Lab03\\Starter\\Exercise02\\Adventure-Works\\Adventure-Works.sln**, and then click **Open**.

4.  In the **Security Warning for Adventure-Works** dialog box, clear the **Ask me for every project in this solution** check box, click **OK**.

5.  In Solution Explorer, double-click **Web.config**.

6.  In App.config, in the **Value** attribute of the **EndpointUrl** key, paste the **URI** value you noted earlier, replacing the text **\<URL\>**.

7.  In the **Value** attribute of the **PrimaryKey** key, paste the **PRIMARY KEY** value you noted earlier, replacing the text **\<PRIMARY KEY\>**.

8.  In Solution Explorer, double-click **Global.asax**.

9.  In Global.asax.cs, after the comment **// TODO: Add Customer repository**, type the following code:
    ```csharp
    Repository<Customer>.Initialize(ConfigurationManager.AppSettings["Collection"]);
    ```

10. After the comment **// TODO: Add ShoppingCartOrder repository**, type the following code:
    ```csharp
    Repository<ShoppingCartOrder>.Initialize(ConfigurationManager.AppSettings["Collection"]);
    ```

#### Task 2: Complete the Customer Controller to Enable Customers to Login and Logout

1.  In Solution Explorer, expand **Controllers**, and then double-click **CustomerController.cs**.

2.  In CustomerController.cs, after the comment **// TODO: Use the repository to retrieve the details of the specified customer**, type the following code:
    ```csharp
    var customer = (await Repository<Customer>.GetItemsAsync(c => c.CustomerID == customerID)).FirstOrDefault();
    ```
3.  After the comment **// TODO: Validation and authentication using the password etc should go here. Only validation is implemented in this example, the user can enter anything in the password field\!**, type the following code:
    ```csharp
    if (customer == null) // No such customer
    {
        TempData["invalidUserOrPassword"] = "Invalid username or password";
        return View();
    }
    ```
4.  After the comment **// TODO: If authentication is successful (it always is in this example), cache the customer details in the session**, type the following code:
    ```csharp
    Session["customer"] = customer;
    ```
5.  After the comment **// TODO: Retrieve the current shopping cart for the customer (if there is one)**, type the following code:
    ```csharp
    var shoppingCart = (await Repository<ShoppingCartOrder>.GetItemsAsync(c => c.CustomerID == customerID && c.IsShoppingCartOrOrder == Constants.SHOPPINGCART)).FirstOrDefault();
    Session["shoppingCart"] = shoppingCart;
    ```
6.  Review the **Logout** method at the end of the file.

#### Task 3: Implement Functionality to Add Items to the Shopping Cart

1.  In Solution Explorer, under **Controllers**, double-click **ShoppingCartController.cs**.

2.  In ShoppingCartController.cs, after the comment **// TODO: Check whether the user has logged in**, type the following code:
    ```csharp
    if (Session["customer"] == null)
    {
        // If not, then get them to log in
        Session["ReturnData"] = new { ReturnURL = "ViewCart", Controller = "ShoppingCart" };
        return View("Login");
    }
    ```
3.  After the comment **// TODO: Retrieve the shopping cart for the customer**, type the following code:
    ```csharp
    var shoppingCart = GetShoppingCartForCustomer(Session["customer"] as Customer);
    ```

4.  After the comment **// TODO: Display the shopping cart**, edit the line:

    ```csharp 
    return View();  
    ```

    so that it reads:
    
    ```csharp
    return View(shoppingCart);
    ```
5.  In ShoppingCartController.cs, after the comment **// TODO: Save the shopping cart using the repository, and then cache it in the session. Set the TTL to 7 days. Note that TTL must be enabled at the collection level for this to work**, type the following code:
    ```csharp
    if (await Repository<ShoppingCartOrder>.UpsertItemAsync(shoppingCart, ttl: 60 * 60 * 24 * 7))
    {
        Session["shoppingCart"] = shoppingCart;

        // Inform the user that the item has been added to the cart
        TempData["itemMessage"] = "Item added to shopping cart";
    }
    else
    {
        // If the upsert failed, then inform the user that the item has not been added to the shopping cart
        TempData["itemMessage"] = "Item not added to shopping cart";
    }
    ```

6.  In Internet Explorer, in the **SQL API** pane, expand **Adventure-Works**, expand **Data**, and then click **Scale & Settings**.

7.  On the **Scale & Settings** tab, under **Settings**, under **Time to Live**, click **On (no default)**, and then click **Save**.

8.  In Visual Studio, press F5 to run and start the application.

9.  On the **Adventure-Works Product Catalog** page, click **Search By Category**.

10. On the first row of search results, click **Details**.

11. On the **Product Details** page, click **Add to Shopping Cart**.

12. On the **Login** page, in the **Customer ID** box, type **10**, and then click **Login**.

13. In the **Message from webpage** dialog box, click **OK**.

14. On the **Shopping Cart** page, click the **Adventure-Works Product Catalog** link.

15. On the **Adventure-Works Product Catalog** page, click **Search By Category**.

16. On the second row of search results, click **Details**.

17. On the **Product Details** page, click **Add to Shopping Cart**.

18. In the **Message from webpage** dialog box, click **OK**.

19. On the **Shopping Cart** page, on the first row, in the **Number Required** box, type **2**, and then click **Update**.

20. In the **Message from webpage** dialog box, click **OK**.

21. On the **Shopping Cart** page, on the second row. click **Delete**.

22. In the **Message from webpage** dialog box, click **OK**.

23. Close the **Shopping Cart** page to stop the application.

24. In Internet Explorer, in the **SQL API** pane, under **Adventure-Works**, right-click **Data**, and then click **New SQL Query**.

25. On the **Query 1** tab, edit the query so that it reads:
    ```SQL
    SELECT * FROM c WHERE c.doctype = "ShoppingCartOrder"
    ```

26. Click **Execute Query**. One row should be returned, corresponding to the shopping cart that you created.

### Exercise 3: Creating Orders and Backorders

#### Task 1: Create the CheckStockAvailable Stored Procedure

1.  In Internet Explorer, in the **SQL API** pane, under **Adventure-Works**, right-click **Data**, and then click **New Stored Procedure**.

2.  On the **New Stored Procedure 1** tab, in the **Stored Procedure Id** box, type **CheckStockAvailable**.

3.  In the **Stored Procedure Body** box, delete the sample stored procedure code, and then type the following code:

    ```javascript
    functionÂ checkStockAvailable(productID, productname, numRequired, customerID){
        varÂ collection = getContext().getCollection();
        var collectionLink = collection.getSelfLink();
        var response = getContext().getResponse();

        var isAccepted = collection.queryDocuments(collectionLink, "SELECT * FROM p WHERE p.doctype = 'Product' AND p.id = '" + productID + "'", {}, function(err, docs, options) {

        // If an error has occurred, abort the stored procedure
        if (err) {
            throw err;
        }
        // Check that a doc was found. If not, throw a "not available" error
        if (!docs || !docs.length) {
            throw new Error("Product " + productname + " is not available");
        }

        elseÂ {
            // If a matching product was found, check for sufficient stock levels
            var productDoc = docs[0];
            if (numRequired > productDoc.quantityinstock) {

                // If there is insufficient stock available, allocate what is there
                var numOnBackorder = numRequired - productDoc.quantityinstock;
                updateStockLevel(productDoc, productDoc.quantityinstock);

                // Create a backorder for the remainder
                var backorder = {
                    doctype: "ProductBackorder",
                    partitionkey: productDoc.partitionkey,
                    customerid: customerID,
                    productid: productDoc.id,
                    productname: productDoc.productname,
                    productnumber: productDoc.productnumber,
                    numberonbackorder: numOnBackorder,
                    backorderstatus: "In progress",
                    backorderdate: getCurrentTimeInNetTicks()
                };

                // Add the backorder to the database.
                // If an error occurs, the stored procedure will be aborted and changes rolled back
                isAccepted = collection.createDocument(collectionLink, backorder, function(err, backorderDoc, options){
                    // If an error has occurred, abort the stored procedure
                    if (err) {
                        throw err;
                    }

                    // Set the response body to indicate how many items were allocated, and the details of any backorder
                    response.setBody('{message: "backorder created", backorderid: "' + backorderDoc.id + '", allocated: ' + (numRequired - numOnBackorder) + ', latestprice:' + productDoc.listprice + '}');
                });

                ifÂ (!isAccepted)Â {
                    throwÂ newÂ Error('Unable to create backorder. Please retry.');
                }
            }
            else {
                    // If there is sufficient stock available, then allocate it
                    updateStockLevel(productDoc, numRequired);
                    response.setBody('{message: "items in stock", allocated: ' + numRequired + ', latestprice:' + productDoc.listprice + '}');
                }
            }
        });

        ifÂ (!isAccepted)Â {
            throwÂ newÂ Error('Unable to check stock level. Please retry.');
        }
    ```
4.  Type the following code, and then click **Save**:

    ```javascript 
        function updateStockLevel(productDoc, numRequired) {
            // Update the stock level
            productDoc.quantityinstock -= numRequired;

            // Save the product doc back to the collection, and check for concurrent updates
            // If an error occurs, the stored procedure will be aborted and changes rolled back
            isAccepted = collection.replaceDocument(productDoc._self, productDoc, {etag: productDoc.Etag});
            ifÂ (!isAccepted)Â {
                throwÂ newÂ Error('Unable to update stock level. Please retry.');
            }
        }

        function getCurrentTimeInNetTicks() {
            // Get the current time
            var now = new Date().getTime();

            // Adjust for 1st Jan 1970
            const ticksBetweenYear1And1970 = 62135596800000;
            now += ticksBetweenYear1And1970

            // Convert the value in now from ms to 100 ns
            now *= 10000;

            // Return the result
            return now;
        }
    }
    ```

#### Task 2: Test the CheckStockAvailable Stored Procedure

1.  In the Azure portal, in the **SQL API** pane, right-click **Data**, and then click **New SQL Query**.

2.  On the **Query 2** tab, edit the query so that it reads the following, and then click **Execute Query**:
    ```SQL
    SELECT * FROM c WHERE c.id = "788"
    ```
3.  In the **Results** pane, note the value of the **quantityinstock** property.

4.  On the **CheckStockAvailable** tab, click **Execute**.

5.  On the **Input parameters** blade, in the **Partition key value** box, type **Mountain Bikes**.

6.  In the **Param** box, type **788**.

7.  Click **Add New Param**, in the new parameter box, type **Mountain 300, Black, 48**.

8.  Click **Add New Param**, in the new parameter box, type **3**.

9.  Click **Add New Param**, in the new parameter box, type **99**, and then click **Execute**.

10. Verify that the stored procedure ran correctly.

11. On the **Query 2** tab, click **Execute Query**. Verify that the value of the **quantityinstock** property has reduced by 3.

12. On the **CheckStockAvailable** tab, click **Execute**.

13. On the **Input parameters** blade, change the value of third parameter from **3** to **300**, and then click **Execute**.

14. Verify that the stored procedure ran correctly.

15. On the **Query 2** tab, click **Execute Query**. Verify that the value of the **quantityinstock** property has reduced to 0.

16. Edit the query so that it reads the following, and then click **Execute Query**:
    ```SQL
    SELECT * FROM c WHERE c.doctype = "ProductBackorder"
    ```

17. Verify that the **numberonbackorder** property reflects the difference between the **quantityinstock** that you noted earlier and the total number of orders you have placed.

18. On the **CheckStockAvailable** tab, click **Execute**.

19. On the **Input parameters** blade, change the value of first parameter from **788** to **7888**, and then click **Execute**.

20. Verify that an error message is returned by the stored procedure.

#### Task 3: Add Stored Procedure Functionality to the Repository

1.  Close any open instances of Visual Studio.

2.  On the Start menu, click **Visual Studio 2017**.

3.  On the **File** menu, point to **Open**, and then click **Project/Solution**.

4.  In the **Open Project** dialog box, in the **File name** box, type **E:\\Labfiles\\Lab03\\Starter\\Exercise03\\Adventure-Works\\Adventure-Works.sln**, and then click **Open**.

5.  In the **Security Warning for Adventure-Works** dialog box, clear the **Ask me for every project in this solution** check box, click **OK**.

6.  In Solution Explorer, double-click **Web.config**.

7.  In App.config, in the **Value** attribute of the **EndpointUrl** key, paste the **URI** value you noted earlier, replacing the text **\<URL\>**.

8.  In the **Value** attribute of the **PrimaryKey** key, paste the **PRIMARY KEY** value you noted earlier, replacing the text **\<PRIMARY KEY\>**.

9.  In Solution Explorer, double-click **Repository.cs**.

10. In Repository.cs, locate the **ExecuteStoredProcAsync** method (line 136).

11. After the comment **// TODO: Get the URI of the stored procedure**, type the following code:
    ```csharp
    Uri storedProcUri = UriFactory.CreateStoredProcedureUri(database, collection, storedProc);
    ```
12. After the comment **// TODO: Specify the partition identified by the partitionKey parameter**, type the following code:
    ```csharp
    var options = partitionKey == null ? null : new RequestOptions
    {
        PartitionKey = new PartitionKey(partitionKey)
    };
    ```
13. After the comment **// TODO: Run the stored procedure**, type the following code:
    ```csharp
    var storedProcResults = await client.ExecuteStoredProcedureAsync<dynamic>(storedProcUri, options, paramList);
    ```
14. After the comment **// TODO: Pass back the results of the stored procedure**, replace:
    ```csharp
    return new NotImplementedException();
    ```

    with:
    ```csharp
    return storedProcResults.Response;
    ```

#### Task 4: Call the CheckStockAvailable Stored Procedure From the App Using the Repository

1.  In Solution Explorer, double-click **Global.asax**.

2.  In Global.asax.cs, after the comment **// TODO: Add ProductBackorder repository**, type the following code:
    ```csharp
    Repository<ProductBackorder>.Initialize(ConfigurationManager.AppSettings["Collection"]);
    ```

3.  In Solution Explorer, expand **Controllers**, and then double-click **ShoppingCartController.cs**.

4.  In ShoppingCartController.cs, after the comment **// TODO: Create a dictionary for tracking whether backorders are created (if insufficient stock is currently available for any order item)**, type the following code:
    ```csharp
    var backorderDetails = new Dictionary<string, string>();
    ```

5.  After the comment **// TODO: Use a stored procedure to check that sufficient stock is available for each item, allocate the stock for this order, or create a backorder if necessary**, type the following code:
    ```csharp
    var response = await Repository<Product>.ExecuteStoredProcAsync("CheckStockAvailable", item.Subcategory, item.ProductID, item.ProductName, item.NumberInCartOrOrdered, (Session["customer"] as Customer).CustomerID);
    var responseData = JsonConvert.DeserializeAnonymousType(response, new { message = "", backorderid = "", allocated = 0, latestprice = 0.0M });
    ```

6.  After the comment **// TODO: Check for backordered items**, type the following code:
    ```csharp
    if ((responseData as dynamic).backorderid != null)
    {
        backorderDetails.Add(item.ProductName, (responseData as dynamic).backorderid);
        item.NumberOnBackorder = item.NumberInCartOrOrdered - (responseData as dynamic).allocated;
        item.BackorderReference = (responseData as dynamic).backorderid;
    }
    ```

7.  After the comment **// TODO: Update the order item with the most up to date cost of the item, and the number allocated**, type the following code:
    ```csharp
    item.NumberInCartOrOrdered = (responseData as dynamic).allocated;
    item.UnitCost = (responseData as dynamic).latestprice;
    item.LineItemTotalCost = (responseData as dynamic).allocated * (responseData as dynamic).latestprice;
    ```

8.  After the comment **// TODO: Mark the order as a confirmed order**, type the following code:
    ```csharp
    shoppingCart.IsShoppingCartOrOrder = Constants.ORDER;
    ```

9.  After the comment **// TODO: Save the order to the database**, type the following code:
    ```csharp
    if (await Repository<ShoppingCartOrder>.UpsertItemAsync(shoppingCart))
    {
        StringBuilder message = new StringBuilder();
        message.Append("Order placed.");
        foreach (var backorder in backorderDetails)
        {
            message.Append($"\\nBackorder created for {backorder.Key}: Reference {backorder.Value}");
        }
        TempData["itemMessage"] = message.ToString();

        // Remove the shopping cart from the Session cache as it is no longer required
        Session.Remove("shoppingCart");
    }
    else
    {
        TempData["itemMessage"] = "Order not placed";
    }
    ```

10. After the comment **// TODO: In the event of an exception, return to the ViewCart display and show the error message**, type the following code:
    ```csharp
        Regex errMsgPattern = new Regex(@".*(?<error>Error:.*)\\r\\nStack.*");
        Match errMsgMatch = errMsgPattern.Match(dce.Message);
        if (errMsgMatch.Success)
        {
            TempData["itemMessage"] = errMsgMatch.Groups["error"].Value;
        }
        else
        {
            TempData["itemMessage"] = dce.Message;
        }
        return RedirectToAction("ViewCart", "ShoppingCart");
    ```

11. Press F5 to run and start the application.

12. On the **Adventure-Works Product Catalog** page, click **Search By Category**.

13. On the first row of search results, click **Details**.

14. On the **Product Details** page, click **Add to Shopping Cart**.

15. On the **Login** page, in the **Customer ID** box, type **20**, and then click **Login**.

16. In the **Message from webpage** dialog box, click **OK**.

17. On the **Shopping Cart** page, click the **Adventure-Works Product Catalog** link.

18. On the **Adventure-Works Product Catalog** page, click **Search By Category**.

19. On the second row of search results, click **Details**.

20. On the **Product Details** page, click **Add to Shopping Cart**.

21. In the **Message from webpage** dialog box, click **OK**.

22. On the **Shopping Cart** page, click **Place Order**.

23. In the **Message from webpage** dialog box, click **OK**.

24. On the **Orders** page, click **Details**, and then click the **Adventure-Works Product Catalog** link.

25. On the **Adventure-Works Product Catalog** page, click **Search By Category**.

26. On the first row of search results, click **Details**.

27. On the **Product Details** page, in the **Number Required** box, type **5000**, and then click **Add to Shopping Cart**.

28. In the **Message from webpage** dialog box, click **OK**.

29. On the **Shopping Cart** page, click **Place Order**.

30. In the **Message from webpage** dialog box, click **OK**.

31. On the **Orders** page, on the second order, click **Details**.

32. On the **Order Details** page, click the **Backorder Reference** link.

33. Close the web application.

34. In Internet Explorer, in the **SQL API** pane, on the **Query 2** tab, edit the query text so that it reads:
    ```SQL
    SELECT * FROM c WHERE c.doctype = "ShoppingCartOrder" AND c.partitionkey = "20"
    ```

35. Click **Execute Query**. Two results should be returned.

36. Edit the query text so that it reads:
    ```SQL
    SELECT * FROM c WHERE c.doctype = "ProductBackorder"
    ```

37. Click **Execute Query**. One result should be returned for **customerid** 20.

### Exercise 4: Maintaining Data and Auditing Orders and Backorders

**Task 1: Create a Pre-Trigger that Completes the Details of an Order**

1.  In Internet Explorer, in the Azure Portal, on the **20777-sql-\<*your name\>-\<the day*\>** blade, click **Data Explorer**.

2.  In the **SQL API** pane, under **Adventure-Works**, right-click **Data**, and then click **New Trigger**.

3.  On the **New Trigger 1** tab, in the **Trigger Id** box, type **CompleteOrderDetails**.

4.  In the **Trigger Type** list, click **Pre**.

5.  In the **Trigger Operation** list, click **All**.

6.  In the **Trigger Body** box, edit the existing code so that it reads:
    ```javascript
    function trigger(){
    var context = getContext();  
    var request = context.getRequest();
    var collection = context.getCollection();  
    var documentBeingUpdated = request.getBody();

    // If the operation being performed is not an upsert, then ignore this trigger
    if (request.getOperationType() != "Upsert") {
        return;
    }

    // Verify the type of the document
    if (!("doctype" in documentBeingUpdated) && documentBeingUpdated.doctype != "ShoppingCartOrder") {
        throw new Error("Wrong type of document");
    }

    // Accumulator for counting the number of individual items in the order
    var numberOfItemsInOrder = 0;

    // Accumulator for counting the total cost of the order (before any customer discount)
    var costOfItemsInOrder = 0;

    // Iterate through the order items in the shopping cart
    documentBeingUpdated.orderitems.forEach(function (orderitem) {

        // Calculate the total number of items in the order, and the cost of these items
        numberOfItemsInOrder += orderitem.numberincartorordered;
        costOfItemsInOrder += orderitem.lineitemtotalcost;
    });

    // Find the discountrate for the customer
    var isAccepted = collection.queryDocuments(collection.getSelfLink(), "SELECT * FROM c WHERE c.doctype = 'Customer' AND c.partitionkey = '" + documentBeingUpdated.partitionkey + "'", {}, function(err, customerDocs, options){
        // Report any errors
        if (err) {
            throw new Error(err);
        }

        // If the specified customer was not found in the collection throw an error with a suitable message
        if (customerDocs.length < 1) {
            throw new Error("Customer " + documentBeingUpdated.partitionkey + " not found");
        }

    // Extract the discount rate from the customer document
        var discountrate = customerDocs[0].discountrate;

        // Apply the discount to the order
        documentBeingUpdated.numberofitems = numberOfItemsInOrder;
        documentBeingUpdated.itemscost = costOfItemsInOrder;
        documentBeingUpdated.customerdiscountrate = discountrate;
        documentBeingUpdated.totalcost = documentBeingUpdated.itemscost * (100 - discountrate) / 100;

        // Set the order status, date placed, and date last updated
        documentBeingUpdated.orderstatus = "In progress";
        documentBeingUpdated.dateplaced = getCurrentTimeInNetTicks();
        documentBeingUpdated.lastupdated = getCurrentTimeInNetTicks();
    });
    ```
7.  Then type the following code:
    ```javascript
        function getCurrentTimeInNetTicks() {
            // Get the current time
            var now = new Date().getTime();

            // Adjust for 1st Jan 1970
            const ticksBetweenYear1And1970 = 62135596800000;
            now += ticksBetweenYear1And1970

            // Convert the value in now from ms to 100 ns
            now *= 10000;

            // Return the result
            return now;
        }

        // If the trigger is out of runtime, throw an error
        if (!isAccepted) {
            throw new Error('Unable to get customer details');
        }

        // Save the changes made to the order
        request.setBody(documentBeingUpdated);
    }
    ```

8.  On the **New Trigger 1** tab, click **Save**.

#### Task 2: Create a Post-trigger that Audits Changes Made to Orders and Backorders

1.  In the **SQL API** pane, under **Adventure-Works**, right-click **Data**, and then click **New Trigger**.

2.  On the **New Trigger 2** tab, in the **Trigger Id** box, type **AuditOrder**.

3.  In the **Trigger Type** list, click **Post**.

4.  In the **Trigger Operation** list, click **All**.

5.  In the **Trigger Body** box, edit the existing code so that it reads:
```javascript
    function trigger(){
        var context = getContext();  
        var response = context.getResponse();
        var collection = context.getCollection();  
        var documentBeingUpdated = response.getBody();
        
        // Verify the type of the document
        if (!("doctype" in documentBeingUpdated) && documentBeingUpdated.doctype != "ShoppingCartOrder" && documentBeingUpdated.docType != "ProductBackorder") {
            throw new Error("Wrong type of document");
        }
        
        // Create a document with the audit details
        var auditDocument = {
            partitionkey: documentBeingUpdated.partitionkey,
            doctype: "AuditDocument",
            doctypebeingaudited: documentBeingUpdated.doctype,
            documentbeingaudited: documentBeingUpdated.id,
            datechanged: getCurrentTimeInNetTicks(),
            statuschangedto: documentBeingUpdated.doctype == "ShoppingCartOrder" ? documentBeingUpdated.orderstatus : documentBeingUpdated.backorderstatus,
            customerid: documentBeingUpdated.doctype == "ShoppingCartOrder" ? documentBeingUpdated.partitionkey : documentBeingUpdated.customerid
        };
        
        // Add the audit document to the database
        var isAccepted = collection.createDocument(collection.getSelfLink(), auditDocument);
        
        // If the trigger is out of runtime, throw an error
        if (!isAccepted) {
            throw new Error('Unable to create audit record');
        }
        
        function getCurrentTimeInNetTicks() {
            // Get the current time
            var now = new Date().getTime();
        
            // Adjust for 1st Jan 1970
            const ticksBetweenYear1And1970 = 62135596800000;
            now += ticksBetweenYear1And1970
        
            // Convert the value in now from ms to 100 ns
            now *= 10000;
        
            // Return the result
            return now;
        }
    }
```
6.  On the **New Trigger 2** tab, click **Save**.

#### Task 3: Add Trigger Functionality to the Repository

1.  Close any open instances of Visual Studio.

2.  On the Start menu, click **Visual Studio 2017**.

3.  On the **File** menu, point to **Open**, and then click **Project/Solution**.

4.  In the **Open Project** dialog box, in the **File name** box, type **E:\\Labfiles\\Lab03\\Starter\\Exercise04\\Adventure-Works\\Adventure-Works.sln**, and then click **Open**.

5.  In the **Security Warning for Adventure-Works** dialog box, clear the **Ask me for every project in this solution** check box, click **OK**.

6.  In Solution Explorer, double-click **Web.config**.

7.  In App.config, in the **Value** attribute of the **EndpointUrl** key, paste the **URI** value you noted earlier, replacing the text **\<URL\>**.

8.  In the **Value** attribute of the **PrimaryKey** key, paste the **PRIMARY KEY** value you noted earlier, replacing the text **\<PRIMARY KEY\>**.

9.  In Solution Explorer, double-click **Repository.cs**.

10. In Repository.cs, locate the **UpsertItemAsync** method, after the comment **// TODO: Set the TTL of the document**, type the following code:
    ```csharp
    item.TimeToLive = ttl;
    ```
11. After the comment **// TODO: Specify the triggers to be invoked (if any)**, type the following code:
    ```csharp
    var options = new RequestOptions
    {
        PreTriggerInclude = preTriggers,
        PostTriggerInclude = postTriggers
    };
    ```

12. After the comment **// TODO: Add/replace the document in the collection and invoke the triggers**, replace:
    ```csharp
    var response = await client.UpsertDocumentAsync(collectionUri, item);
    ```

    with:
    ```csharp
    var response = await client.UpsertDocumentAsync(collectionUri, item, options);
    ```

#### Task 4: Invoke the Triggers

1.  In Solution Explorer, expand **Controllers**, and then double-click **ShoppingCartController.cs**.

2.  In ShoppingCartController.cs, after the comment **// Save the order to the database** (line 274), replace:
    ```csharp
    if (await Repository<ShoppingCartOrder>.UpsertItemAsync(shoppingCart))
    ```
    
    with:

    ```csharp
    if (await Repository<ShoppingCartOrder>.UpsertItemAsync(shoppingCart, preTriggers: new List<string> { "CompleteOrderDetails" }))
    ```

3.  In Solution Explorer, under **Controllers**, double-click **OrdersController.cs**.

4.  In OrdersController.cs, in the **CancelOrderAsync** method, after the comment **// TODO: Save the order, and fire AuditOrder post-trigger** (line 116) , replace:
    ```csharp
    if (1==0)
    ```

    with:
    ```csharp
    if (await (Repository<ShoppingCartOrder>.UpsertItemAsync(orderToCancel, postTriggers: new List<string> { "AuditOrder" })))
    ```

5.  Still in the **CancelOrderAsync** method, after the comment **// TODO: Save the backorder, and fire the AuditOrder post-trigger**, type the following code:
    ```csharp
    if (await (Repository<ProductBackorder>.UpsertItemAsync(backorderToCancel, postTriggers: new List<string> { "AuditOrder" })))
    {
        message.Append($"\nBackorder {orderItem.BackorderReference} cancelled");
    }
    ```

6.  Scroll down to the **CancelBackorderAsync** method at the end of the class. In this method, after the comment **// TODO: Save the backorder, and fire the AuditOrder post-trigger** (line 219), type the following code:
    ```csharp
    if (await (Repository<ProductBackorder>.UpsertItemAsync(backorderToCancel, postTriggers: new List<string> { "AuditOrder" })))
    {
        TempData["itemMessage"] = $"Backorder {backorderID} cancelled";
    }
    ```

7.  Press F5 to run and start the application.

8.  On the **Adventure-Works Product Catalog** page, in the **Categories** list , click **Clothing**, and then click **Search By Category**.

9.  On the first row of search results, click **Details**.

10. On the **Product Details** page, click **Add to Shopping Cart**.

11. On the **Login** page, in the **Customer ID** box, type **30**, and then click **Login**.

12. In the **Message from webpage** dialog box, click **OK**.

13. On the **Shopping Cart** page, click **Place Order**.

14. In the **Message from webpage** dialog box, click **OK**.

15. On the **Order Details** page, click the **Adventure-Works Product Catalog** link.

16. On the **Adventure-Works Product Catalog** page, in the **Categories** list , click **Clothing**, and then click **Search By Category**.

17. On the first row of search results, click **Details**.

18. On the **Product Details** page, in the **Number Required** box, type **5000**, and then click **Add to Shopping Cart**.

19. In the **Message from webpage** dialog box, click **OK**.

20. On the **Shopping Cart** page, click **Place Order**.

21. In the **Message from webpage** dialog box, click **OK**.

22. On the **Orders** page, on the second order, click **Details**.

23. On the **Order Details** page, click the **Backorder Reference** link.

24. Close the web application, and then close Visual Studio.

25. In Internet Explorer, in the **SQL API** pane, on the **Query 2** tab, edit the query text so that it reads:
    ```SQL
    SELECT * FROM c WHERE c.doctype = "ShoppingCartOrder" AND c.partitionkey = "30"
    ```

26. Click **Execute Query**. Two results should be returned.

27. Edit the query text so that it reads:
    ```SQL
    SELECT * FROM c WHERE c.doctype = "ProductBackorder"
    ```

28. Click **Execute Query**. Three results should be returned - two from Exercise 3, the other from Exercise 4.

#### Task 5: Lab Close Down

To reduce your costs delete the resource group containing your Cosmos DB databases:

1.  In Internet Explorer, in the Azure Portal, click **Resource groups**.

2.  Right-click **20777\_Mod03**, and then click **Delete resource group**.

3.  On the **Are you sure you want to delete "20777\_Mod03"?** blade, in the **TYPE THE RESOURCE GROUP NAME:** box, type **20777\_Mod03**, and then click **Delete**.

4.  When you have finished, close Internet Explorer.

---
Â© 2018 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode), additional terms may apply. All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant. This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided "as-is." Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.
