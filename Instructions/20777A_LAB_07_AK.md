# Module 7: Implementing Stream Processing with Cosmos DB

- [Module 7: Implementing Stream Processing with Cosmos DB](#module-7-implementing-stream-processing-with-cosmos-db)
  - [Lab: Using Cosmos DB with Stream Processing](#lab-using-cosmos-db-with-stream-processing)
  - [Exercise 1: Monitoring stock levels](#exercise-1-monitoring-stock-levels)
    - [Task 1: Prepare the Environment](#task-1-prepare-the-environment)
    - [Task 2: Create a Cosmos DB collection for holding product sales statistics](#task-2-create-a-cosmos-db-collection-for-holding-product-sales-statistics)
    - [Task 3: Create an Azure Databricks account and cluster](#task-3-create-an-azure-databricks-account-and-cluster)
    - [Task 4: Create a Spark notebook for streaming orders data](#task-4-create-a-spark-notebook-for-streaming-orders-data)
    - [Task 5: Place orders and examine the streamed results](#task-5-place-orders-and-examine-the-streamed-results)
  - [Exercise 2: Handling orders](#exercise-2-handling-orders)
    - [Task 1: Create Azure ServiceBus Queues](#task-1-create-azure-servicebus-queues)
    - [Task 2: Create an Azure Functions App account](#task-2-create-an-azure-functions-app-account)
    - [Task 3: Create the HandleOrders function](#task-3-create-the-handleorders-function)
    - [Task 4: Test the HandleOrders function](#task-4-test-the-handleorders-function)
    - [Task 5: Observe the query overhead of using the change feed](#task-5-observe-the-query-overhead-of-using-the-change-feed)
  - [Exercise 3: Displaying rolling revenue for a given time period](#exercise-3-displaying-rolling-revenue-for-a-given-time-period)
    - [Task 1: Create a Databricks notebook for calculating rolling revenue](#task-1-create-a-databricks-notebook-for-calculating-rolling-revenue)
    - [Task 2: Place orders and observe the rolling revenue](#task-2-place-orders-and-observe-the-rolling-revenue)
  - [Exercise 4: Handling product deliveries](#exercise-4-handling-product-deliveries)
    - [Task 1: Create an Azure IoT Hub](#task-1-create-an-azure-iot-hub)
    - [Task 2: Create an Azure Stream Analytics Job](#task-2-create-an-azure-stream-analytics-job)
    - [Task 3: Create a Cosmos DB collection for holding the details of product deliveries](#task-3-create-a-cosmos-db-collection-for-holding-the-details-of-product-deliveries)
    - [Task 4: Connect the IoT Hub, Stream Analytics Job, and Cosmos DB Database](#task-4-connect-the-iot-hub-stream-analytics-job-and-cosmos-db-database)
    - [Task 5: Create the ProcessDeliveries function](#task-5-create-the-processdeliveries-function)
    - [Task 6: Simulate deliveries arriving at the warehouse](#task-6-simulate-deliveries-arriving-at-the-warehouse)
    - [Task 7: Clean up the lab environment](#task-7-clean-up-the-lab-environment)

## Lab: Using Cosmos DB with Stream Processing

## Exercise 1: Monitoring stock levels

### Task 1: Prepare the Environment

1. Ensure that the **MT17B-WS2016-NAT** and **20777A-LON-DEV** virtual machines are running, and then log on to **20777A-LON-DEV** as **LON-DEV\\Administrator** with the password **Pa55w.rd**.
2. In File Explorer, navigate to **E:\\Labfiles\\Lab07\\Starter**, right-click **full-cosmos-setup.ps1.txt**, and then click **Edit**.
3. In Notepad, edit **20777-mod7-sql-\<*your initials\>\<day*\>** and change the **\<*your initials\>\<day*\>** to your initials and a number between 1 and 31, for example **20777-mod7-sql-pjs14**.
4. Edit **20777blobmod7\<*your initials*\>** and change the **\<*your initials*\>** to your initials and a number between 1 and 31, for example, **20777blobmod7pjs14**.
5. Edit **resourceGroupLocation** variable to specify the name of your nearest location.
6. On the **File** menu, click **Save**, and then close Notepad.
7. In File Explorer, right-click **Setup.cmd**, and then click **Run as administrator**.
8. At the **Security warning** messages, type **R**, and then press Enter.
9. When prompted enter your Azure credentials.
10. When the script completes, press any key to close the command window.
11. On the toolbar, click **Internet Explorer**.
12. In Internet Explorer, go to **http://portal.azure.com**, and sign in using the Microsoft account that is associated with your Azure Learning Pass subscription.
13. In the Azure portal, in the left panel, click **All resources**, and then click **20777-mod7-sql-\<*your initials\>\<day*\>**.
14. On the **20777-mod7-sql-\<*your initials\>\<day*\>** blade, under **Settings**, click **Keys**.
15. Make a note of the **URI**, and **PRIMARY KEY** values.
16. In the left panel, click **All resources**, and then click **20777blobmod7\<*your initials*\>**.
17. On the **20777blobmod7\<*your initials*\>** blade, under **Settings**, click **Access keys**.
18. Make a note of the **Connection string** under **key1**.
19. On the Windows Start menu, click **Visual Studio 2017**.
20. On the **File** menu, point to **Open**, and then click **Project/Solution**.
21. In the **Open Project** dialog box, go to **E:\\Labfiles\\Lab07\\Starter\\MigrateProductData**, click **MigrateProductData.sln**, and then click **Open**.
22. In the **Security Warning for MigrateProductData** dialog box, clear the **Ask me for every project in this solution** check box, and then click **OK**.
23. In Solution Explorer, click **App.config**.
24. On the **App.config** tab, replace **\~URI\~** with the **URI**, and replace **\~KEY\~** with the **PRIMARY KEY** you noted earlier for the **20777-mod7-sql-\<*your initials\>\<day*\>** Cosmos DB account.
25. In the **BlobStorageConnectionString** setting, replace **\~CONNECTION STRING\~** with the **key1 Connection string** you noted earlier for the **20777blobmod7\<*your initials*\>** blob storage account.
26. Press F5 to build and run the application. 
27. In the console window, wait until the application has completed, and the close the application.
28. Close Visual Studio.

### Task 2: Create a Cosmos DB collection for holding product sales statistics

1. In Internet Explorer, in the Azure portal, in the left panel, click **All resources**, and then click **20777-mod7-sql-\<*your initials\>\<day*\>**.
2. On the **20777-mod7-sql-\<*your initials\>\<day*\>** blade, click **Data Explorer**.
3. In the **SQL API** pane, right-click **Adventure-Works**, and then click **New Collection**.
4. On the **Add Collection** blade, in the **Collection Id** box, type **ProductSales**.
5. In the **Partition key** box, type **/productnumber**, and then click **OK**.

### Task 3: Create an Azure Databricks account and cluster

1. In the Azure portal, in the left panel, click **+ Create a resource**, in the search box, type **Azure Databricks**, and then press Enter.
2. On the **Everything** blade, click **Azure Databricks**, and then click **Create**.
3. On the **Azure Databricks Service** blade, in the **Workspace name** box, type **20777a-databricks-\<*your name\>-\<the day*\>**.
4. Under **Resource group**, click **Use existing**, and then in the drop-down list, click **20777Mod07**.
5. In the **Location** drop-down list, click **West US 2**.

    > **Note**: Currently, not all regions support the full range of VMs used by Azure Databricks to host Spark clusters, **West US 2** does.

6. In the **Pricing Tier** drop-down list, click **Trial (Premium - 14-Days Free DBUs)**, and then click **Create**.
7. Wait while the service is deployed.
8. In the left panel, click **All resources**, and then click **20777a-databricks-\<*your name\>-\<the day*\>**.
9. On the **20777a-databricks-\<*your name\>-\<the day*\>** blade, click **Launch Workspace**.
10. On the **Azure Databricks** page, under **Common Tasks**, click **New Cluster**.
11. On the **New Cluster** page, in the **Cluster Name** box, type **\<*your name*\>-cluster**.
12. In the **Max Workers** box, type **4**.
13. Leave all other settings at their default values, and then click **Create Cluster**.
14. Wait while the cluster is created and started. Verify that its **State** is set to **Running** before continuing.

### Task 4: Create a Spark notebook for streaming orders data

> **Note**: The Scala code used in this task can be found in the file **E:\\Labfiles\\Lab07\\Solution\\Exercise01\\monitorstocklevels.txt**.

1. In the left toolbar, click **Azure Databricks**.
2. Under **Common Tasks**, click **Import Library**.
3. On the **New Library** page, in the **Source** drop-down list, click **Upload Java/Scala JAR**.
4. In the **Library Name** box, type **Cosmos DB Connector**.
5. Click the **Drop library JAR here to upload** text.
6. In the **JAR File** box, go to the **E:\\Labfiles\\Lab07\\Starter\\Exercise01** folder, click **azure-cosmosdb-spark_2.3.0_2.11-1.2.0-uber.jar**, and then click **Open**.
7. When the JAR file has been uploaded, click **Create Library**.
8. On the **Cosms DB Connector** page, in the **\<*your name*\>-cluster** row, select the **Attach** check box, and wait until the status of the library changes to **Attached**.
9. In the toolbar on the left of the blade, click **Azure Databricks**.
10. Under **Common Tasks**, click **New Notebook**.
11. In the **Create Notebook** dialog box, in the **Name** box, type **monitorstocklevels**.
12. In the **Language** drop-down list, click **Scala**.
13. In the **Cluster** drop-down list, click **\<*your name*\>-cluster**, and then click **Create**.
14. In the first cell of the notebook, enter the following code.

    ```Scala
    // Import libraries required for streaming, and for the Cosmos DB connector

    import org.apache.spark.SparkConf
    import org.apache.spark.SparkContext
    import com.microsoft.azure.cosmosdb.spark.config.Config
    import com.microsoft.azure.cosmosdb.spark.schema._
    import com.microsoft.azure.cosmosdb.spark.streaming._
    import org.apache.spark.sql.functions._
    import java.sql.Timestamp
    ```

15. In the toolbar at the top right-hand side of the cell, on the **Edit Menu** menu, click **Add Cell Below**.
16. In the new cell, type the following code. Replace **--URI--** with the **URI**, and replace **--KEY--** with the **PRIMARY KEY** values that you noted earlier for the **20777-mod7-sql-\<*your initials\>\<day*\>** Cosmos DB account.

    ``` Scala
    // Configure the connection to the Cosmos DB database

    val databaseReadConfig = Map(
        "endpoint" -> "--URI--",
        "masterkey" -> "--KEY--",
        "database" -> "Adventure-Works",
        "collection" -> "Data",
        "readchangefeed" -> "true",
        "changefeedqueryname" -> "ordersquery",
        "changefeedstartfromthebeginning" -> "false",
        "samplingratio" -> "1.0",
        "schema_samplesize" -> "1000",
        "changefeedcheckpointlocation" -> "/checkpointlocation"
    )
    ```

17. In the toolbar at the top right-hand side of the cell, on the **Edit Menu** menu, click **Add Cell Below**.
18. In the new cell, type the following code:

    ```Scala
    // Specify that spark should stream data from the change feed

    val changeFeedStream = spark
        .readStream
        .format(classOf[CosmosDBSourceProvider].getName)
        .options(databaseReadConfig)
        .load()
    ```

19. In the toolbar at the top right-hand side of the cell, on the **Edit Menu** menu, click **Add Cell Below**.
20. In the new cell, type the following code:

    ```Scala
    // The change feed contains documents of many types
    // Filter out all documents that are not new orders

    val ordersStream = changeFeedStream.filter("doctype == 'ShoppingCartOrder' AND isshoppingcartororder == 'Order' AND orderstatus == 'In progress'")
    ```
21. In the toolbar at the top right-hand side of the cell, on the **Edit Menu** menu, click **Add Cell Below**.
22. In the new cell, type the following code:

    ```Scala
    // Isolate the orderitems data, an array containing the number of items ordered for each product in the order, from the rest of the data

    val orderitemsFrame = ordersStream.select(explode($"orderitems").as("orderitems"))
    ```

23. In the toolbar at the top right-hand side of the cell, on the **Edit Menu** menu, click **Add Cell Below**.
24. In the new cell, type the following code:

    ```Scala
    // Add the current timestamp to the data frame.
    // This will be used for time watermarking and windowing

    val orderitemsFrameWithTimestamp = orderitemsFrame.withColumn("now", current_timestamp)
    ```

25. In the toolbar at the top right-hand side of the cell, on the **Edit Menu** menu, click **Add Cell Below**.
26. In the new cell, type the following code:

    ```Scala
    // Calculate the number sold and number placed on backorder for products in all orders placed in the last 30 seconds

    val productsSoldFrame = orderitemsFrameWithTimestamp
        .withWatermark("now", "15 seconds")
        .groupBy($"orderitems.productname", $"orderitems.productnumber", window($"now", "30 seconds").as("timeslot"))
        .agg(sum($"orderitems.numberincartorordered").as("numberordered"), sum($"orderitems.numberonbackorder").as("numberonbackorder"))
    ```

27. In the toolbar at the top right-hand side of the cell, on the **Edit Menu** menu, click **Add Cell Below**.
28. In the new cell, type the following code. Replace **--URI--** with the **URI**, and replace **--KEY--** with the **PRIMARY KEY** values that you noted earlier for the **20777-mod7-sql-\<*your initials\>\<day*\>** Cosmos DB account.

    ```Scala
    // Stream the results back to Cosmos DB

    val databaseWriteConfig = Map(
        "endpoint" -> "--URI--",
        "masterkey" -> "--KEY--",
        "database" -> "Adventure-Works",
        "collection" -> "ProductSales",
        "checkpointLocation" -> "/checkpointwritelocation" // Note the capital "L" in "checkpointLocation"
    )

    val results = productsSoldFrame
        .select($"productnumber", $"productname", $"numberordered", $"numberonbackorder", date_format($"timeslot.end", "HH:mm:ss").as("timeslot"))
        .writeStream
        .format(classOf[CosmosDBSinkProvider].getName)
        .outputMode("append")
        .options(databaseWriteConfig)
        .start()
    ```

### Task 5: Place orders and examine the streamed results

1. On the Windows Start menu, click **Visual Studio 2017**.
2. On the **File** menu, point to **Open**, and then click **Project/Solution**.
3. In the **Open Project** dialog box, go to **E:\\Labfiles\\Lab07\\Starter\\Exercise01\\PlaceOrders**, and then double-click **PlaceOrders.sln**. This app simulates customers placing orders.
4. In the **Security Warning for PlaceOrders** dialog box, clear the **Ask me for every project in this solution** check box, and then click **OK**.
5. In Solution Explorer, click **App.config**.
6. On the **App.config** tab, replace **\~URI\~** with the **URI**, and replace **\~KEY\~** with the **PRIMARY KEY** values that you noted earlier for the **20777-mod7-sql-\<*your initials\>\<day*\>** Cosmos DB account.
7. Press F5 to build and run the application. You will see messages indicating that orders are being created and added to the database.
8. Allow the app to run for a minute, and then return to the Databricks notebook.
9. In the toolbar at the top of the notebook, click **Run All**. Wait for the final cell in the notebook to indicate that it has started streaming data; the cell should run continuously, and you will see a **Last updated** message appear at regular intervals.

    > **Note**: The cell that starts streaming the data from the change feed maight report the error **Failed to load class "org.slf4j.impl.StaticLoggerBinder"**. You can ignore this error.

10. Switch to the Azure portal.
11. In Internet Explorer, in the left panel, click **All resources**, and then click **20777-mod7-sql-\<*your initials\>\<day*\>**.
12. On the **20777-mod7-sql-\<*your initials\>\<day*\>** blade, click **Data Explorer**, expand **Adventure-Works**, expand **ProductSales**, and then click **Documents**.
13. Click any document in the collection. It should contain data similar to that shown below. The **timeslot** field indicates the end of the 30 second period during which the data was captured. The **numberordered** value shows how many items of the specified product were ordered in that interval, and the **numberonbackorder** value indicates how many items were placed on backorder because there is insufficient stock in place to satisfy orders.

    ```JSON
    {
        "productnumber": "FR-M94B-42",
        "timeslot": "11:32:00",
        "productname": "HL Mountain Frame - Black, 42",
        "numberordered": 1,
        "numberonbackorder": 2,
        "id": "65ec316e-b973-49eb-aed8-ff4df0760872",
        "_rid": "T3ILALy68wAKAAAAAAAAAA==",
        "_self": "dbs/T3ILAA==/colls/T3ILALy68wA=/docs/T3ILALy68wAKAAAAAAAAAA==/",
        "_etag": "\"0200812d-0000-0000-0000-5b7bf85e0000\"",
        "_attachments": "attachments/",
        "_ts": 1534851166
    }
    ```

14. In the **SQL API** pane, click **New SQL Query**.
15. On the **Query 1** tab, enter the following query. Replace **\<Product Number\>** with the product number from the document that you just browsed, for example **FR-M94B-42**.

    ```SQL
    SELECT * FROM c WHERE c.productnumber = "<Product Number>"
    ```

16. Click **Execute Query**. You will see sales summary documents for each 30 second period during which orders were placed for the product. If any periods are missing, then no orders were received for the item.
17. Note the number of documents returned by the query, wait for a minute, and then click **Execute Query**. If more orders have been placed, then more documents should be created.
18. In Visual Studio 2017, on the **Debug** menu, click **Stop Debugging**, and then close Visual Studio.
19. In Internet Explorer, in the **monitorstocklevels** notebook, in the toolbar at the top of the notebook, click **Stop Execution**.
20. Close the **Azure Databricks** portal.

## Exercise 2: Handling orders

### Task 1: Create Azure ServiceBus Queues

1. In the Azure portal, in the left panel, click **+ Create a resource**.
2. On the **New** blade, in the search box, type **Azure ServiceBus**, and then press Enter.
3. On the **Everything** blade, click **Service Bus**, and then click **Create**.
4. On the **Create namespace** blade, in the **Name** box, type **sb-20777-\<*your name\>-\<the day*\>**, for example, **sb-20777-john-31**.
5. In the **Pricing tier** drop-down list box, click **Basic**.
6. Under **Resource group**, in the drop-down list, click **20777Mod07**.
7. In the **Location** box, select a location near you, and then click **Create**.
8. In the Azure portal, in the left panel, click **All resources**, and then click **sb-20777-\<*your name\>-\<the day*\>**.
9. On the **sb-20777-\<*your name\>-\<the day*\>** blade, click **+ Queue**.
10. On the **Create queue** blade, in the **Name** box, type **customerordersqueue**, leave the remaining fields at their default values, and then click **Create**.
11. On the **sb-20777-\<*your name\>-\<the day*\>** blade, click **+ Queue**.
12. On the **Create queue** blade, in the **Name** box, type **warehousequeue**, leave the remaining fields at their default values, and then click **Create**.
13. On the **sb-20777-\<*your name\>-\<the day*\>** blade, under **Settings**, click **Shared access policies**.
14. On the **Shared access policies** blade, click the **RootManageSharedAccessKey** policy.
15. Make a note of the **Primary Connection String** value.

### Task 2: Create an Azure Functions App account

1. In the left panel, click **+ Create a resource**.
2. In the **New** blade, in the search box, type **Function App**, and then press Enter.
3. On the **Everything** blade, click **Function App**, and then click **Create**.
4. On the **Function App** blade, in the **App name** box, type **20777-func-\<*your name\>-\<the day*\>**, for example, **20777-func-john-31**.
5. Under **Resource Group**, click **Use existing**, then in the drop-down list, click **20777Mod07**.
6. In the **Location** box, select a location near you; you should use the same location that you used for your Cosmos DB account if it appears in the list.
7. Ensure **Application Insights** is set to **Disabled**.
8. Leave all other settings at their default values, and then click **Create**.

### Task 3: Create the HandleOrders function

> **Note**: The complete code for the **HandleOrders** function is available in the file **E:\\Labfiles\\Lab07\\Solution\\Exercise02\\HandleOrders.txt**.

1. In the left panel, click **All resources**, and then click **20777-func-\<*your name\>-\<the day*\>**.
2. On the **20777-func-\<*your name\>-\<the day*\>** blade, click **Functions**, and then click **+ New function**.
3. On the **Choose a template below or go to the quickstart** blade, click **Azure Cosmos DB trigger**. 

    > **Note**: If the **Extensions not Installed** pane appears, click **Install** to install the template dependencies required to create Cosmos DB triggers, and then click **Continue** when installation is complete.

4. In the **Name** box, type **HandleOrders**.
5. Under **Azure Cosmos DB trigger**, click **new**.
6. In the **Connection** dialog box, click **Azure Cosmos DB account**.
7. In the **Subscription** drop-down list, select your own subscription.
8. In the **Database Account** drop-down list, click **20777-mod7-sql-\<*your initials\>\<day*\>**, and then click **Select**.
9. On the **New Function** blade, in the **Collection name** box, type **Data**.
10. Select the **Create lease collection if it does not exist** check box.
11. In the **Database name** box, type **Adventure-Works**.
12. Leave **Collection name for leases** set to **leases**, and then click **Create**.
13. In the **Function Apps** pane, under the **HandleOrders** function, click **Integrate**.
14. In the **Outputs** box, click **New Output**.
15. Click **Azure Service Bus**, and then click **Select**.
16. In the **Azure Service Bus output** box, under the message **This integration requires the following extensions: Microsoft.Azure.WebJobs.Extensions.ServiceBus**, click **Install**
17. In the **Message type** drop-down list, click **Service Bus Queue**.
18. In the **Message parameter name** box, type **customerOrdersQueue**.
19. Next to **Service Bus connection**, click **new**.
20. In the **Connection** dialog box, click **Service Bus**.
21. In the **Namespace** drop-down list, click **sb-20777-\<*your name\>-\<the day*\>**, and then click **Select**.
22. In the **Queue name** box, type **customerordersqueue**, and then click **Save**
23. Repeat steps 14 through 22 to add another Service Bus output with the following configuration:

    - **Message type**: Service Bus Queue.
    - **Message parameter name**: warehouseQueue.
    - **Service Bus connection**:  use the default connection (this should be the one that you created for the previous Service Bus output)
    - **Queue name**: warehousequeue.

24. In the **Function Apps** pane, click the **HandleOrders** function.
25. On the **run.csx** blade, type the following code to add a reference to the **Newtonsoft.Json** assembly at the top of the file, after the reference to the **Microsoft.Azure.DocumentDB.Core** assembly:

    ```CSharp
    #r "Newtonsoft.Json"
    ```

26. Add the following **Using** directive to the code, after the existing **Using** directives. This directive brings the **Newtonsoft.Json** namespace into scope:

    ```CSharp
    using Newtonsoft.Json;
    ```

27. After the closing brace of the **Run** function, add the following class definitions to the file:

    ```CSharp
    // Base class for all root document types
    public abstract class DocumentType
    {
        [JsonProperty("doctype")]
        public string DocType { get; set; }

        [JsonProperty("ttl")]
        public int TimeToLive { get; set; } = -1;

        public DocumentType()
        {
            this.DocType = this.GetType().Name;
        }
    }

    public class OrderItem
    {
        [JsonProperty("productnumber")]
        public string ProductNumber { get; set; }

        [JsonProperty("productname")]
        public string ProductName { get; set; }

        [JsonProperty("productid")]
        public string ProductID { get; set; }

        [JsonProperty("subcategory")]
        public string Subcategory { get; set; }

        [JsonProperty("numberincartorordered")]
        public int NumberInCartOrOrdered { get; set; }

        [JsonProperty("numberonbackorder")]
        public int NumberOnBackorder { get; set; }

        [JsonProperty("backorderreference")]
        public string BackorderReference { get; set; }

        [JsonProperty("unitcost")]
        public decimal UnitCost { get; set; }

        [JsonProperty("lineitemtotalcost")]
        public decimal LineItemTotalCost { get; set; }
    }

    public class ShoppingCartOrder : DocumentType
    {
        [JsonProperty("id")]
        public string ShoppingCartOrderID { get; set; }

        [JsonProperty("partitionkey")]
        public string CustomerID { get; set; }

        [JsonProperty("isshoppingcartororder")]
        public string IsShoppingCartOrOrder { get; set; }

        [JsonProperty("orderitems")]
        public List<OrderItem> OrderItems { get; set; }

        [JsonProperty("numberofitems")]
        public int NumberOfItems { get; set; }

        [JsonProperty("itemscost")]
        public decimal ItemsCost { get; set; }

        [JsonProperty("customerdiscountrate")]
        public int CustomerDiscountRate { get; set; }

        [JsonProperty("totalcost")]
        public decimal TotalCost { get; set; }

        [JsonProperty("dateplaced")]
        public long DatePlaced { get; set; }

        [JsonProperty("orderstatus")]
        public string OrderStatus { get; set; } // "In progress", "Delivered", "Cancelled"

        [JsonProperty("lastupdated")]
        public long LastUpdated { get; set; }
    }
    ```

28. Modify the definition of the **Run** method and add the two output parameters for the Service Bus queues, as follows:

    ```CSharp
    public static void Run(IReadOnlyList<Document> input, ILogger log, ICollector<string> customerOrdersQueue, ICollector<string> warehouseQueue)
    ```
    
    > **Note**: The Service Bus Webjobs extension abstracts the message queues as **ICollector** objects. YOu post a message to the queue simply by using the **Add** method of the **ICollector** interface.

29. Remove the following two statements from the body of the function:

    ```CSharp
    log.LogInformation("Documents modified " + documents.Count);
    log.LogInformation("First document Id " + documents[0].Id);
    ```

30. Inside the **if** statement, add the following statements.

    ```CSharp
    // Iterate through the change feed
    foreach (Document doc in input)
    {

    }
    ```

31. Inside the **foreach** statement, add the following code:

    ```CSharp
    // The change feed can contain documents of many different types (customers, products, orders, etc)
    // We are only interested in new orders ("In progress"), so filter out the others types of documents and orders ("Delivered", "Cancelled")
    ShoppingCartOrder orderDoc = JsonConvert.DeserializeObject<ShoppingCartOrder>(doc.ToString());
    if (orderDoc.DocType == "ShoppingCartOrder" && orderDoc.IsShoppingCartOrOrder == "Order" && orderDoc.OrderStatus == "In progress")
    {

    }
    ```

32. Inside the nested **if** statement you added in the previous step, add the following code:

    ```CSharp
    // The doc is for an order
    // Alert the warehouse with the details of the items in the order
    foreach (OrderItem item in orderDoc.OrderItems)
    {
        log.LogInformation($"New order for {item.NumberInCartOrOrdered} of {item.ProductNumber} ({item.ProductName})");
        warehouseQueue.Add(JsonConvert.SerializeObject(item));
    }

    // Send a message to the customer orders department containing the details of the order
    log.LogInformation($"New order, {orderDoc.ShoppingCartOrderID}, for customer {orderDoc.CustomerID}. Value is {orderDoc.TotalCost}");
    customerOrdersQueue.Add(JsonConvert.SerializeObject(orderDoc));
    ```

33. Click **Save**.

### Task 4: Test the HandleOrders function

1. On the **run.csx** blade, click **Logs**.
2. On the Windows Start menu, click **Visual Studio 2017**.
3. On the **File** menu, point to **Open**, and then click **Project/Solution**.
4. In the **Open Project** dialog box, go to **E:\\Labfiles\\Lab07\\Starter\\Exercise02\\Adventure-Works**, and then double-click **Adventure-Works.sln**.
5.  In the **Security Warning for PlaceOrders** dialog box, clear the **Ask me for every project in this solution** check box, and then click **OK**.
6.  In Solution Explorer, click **Web.config**.
7.  On the **Web.config** tab, in the **appSettings** section, replace **\~URI\~** with the **URI**, and replace **\~KEY\~** with the **PRIMARY KEY** values that you noted earlier for the **20777-mod7-sql-\<*your initials\>\<day*\>** Cosmos DB account.
8.  Press F5 to build and run the application.
9.  In the web app, click **Search By Category**. For the first item returned by the search, click **Details**, and then click **Add to Shopping Cart**.
10. On the **Login** page, in the **Customer ID** box, type **1**, and then click **Login**.
11. In the **Item added to shopping cart** dialog box, click **OK**.
12. Do not click **Place Order** just yet.
13. On the **Azure portal** tab, showing the log trace for the **HandleOrders** function, verify that it displays messages similar to these:

    ```Text
    2018-10-10T17:00:41.294 [Information] Executing 'Functions.HandlerOrders' (Reason='New changes on collection Data at 2018-10-10T17:00:41.2930445Z', Id=94d0a322-dc7b-493c-b96b-557502f9a01c)
    2018-10-10T17:00:41.297 [Information] Executed 'Functions.HandlerOrders' (Succeeded, Id=94d0a322-dc7b-493c-b96b-557502f9a01c)
    ```

14. On the **Adventure-Works** tab, click **Place Order**.
15. In the **Order placed** dialog box, click **OK**.
16. On the **Azure portal** tab, in the log for the Azure function, you should now see messages similar to these included in the output:

    ```Text
    2018-10-10T17:04:26.243 [Information] New order for 1 of PD-M282 (LL Mountain Pedal)
    2018-10-10T17:04:29.113 [Information] New order, 92ba4d40-a970-48e4-a98d-bad85edacb38, for customer 1. Value is 36.441
    ```

17. On the Start menu, click **Visual Studio 2017** to start another instance of Visual Studio 2017.
18. On the **File** menu, point to **Open**, and then click **Project/Solution**.
19. In the **Open Project** dialog box, go to **E:\\Labfiles\\Lab07\\Starter\\Exercise02\\CustomerOrders**, and then double-click **CustomerOrders.sln**. This app monitors the customerordersqueue ServiceBus queue.
20. In the **Security Warning for PlaceOrders** dialog box, clear the **Ask me for every project in this solution** check box, and then click **OK**.
21. In Solution Explorer, click **App.config**.
22. On the **App.config** tab, in the **appSettings** section, replace **\~CONNECTION STRING\~** with the **Primary Connection String** value that you noted earlier for the **sb-20777-\<*your name\>-\<the day*\>** Service Bus.
23. Press F5 to build and run the application. You should see a message appear that describes the order you just placed using the Adventure-Works web site (if you placed more than one order, you will see more than one message). This message was posted by the **HandleOrders** Azure Function App.
24. Leave the app running.
25. On the Start menu, click **Visual Studio 2017** to start another instance of Visual Studio 2017.
26. On the **File** menu, point to **Open**, and then click **Project/Solution**.
27. In the **Open Project** dialog box, go to **E:\\Labfiles\\Lab07\\Starter\\Exercise02\\Warehouse**, and then double-click **Warehouse.sln**. This app monitors the warehousequeue ServiceBus queue.
28. In the **Security Warning for PlaceOrders** dialog box, clear the **Ask me for every project in this solution** check box, and then click **OK**.
29. In Solution Explorer, click **App.config**.
30. On the **App.config** tab, in the **appSettings** section, replace **\~CONNECTION STRING\~** with the **Primary Connection String** value that you noted earlier for the **sb-20777-\<*your name\>-\<the day*\>** Service Bus.
31. Press F5 to build and run the application. You should see a messages appear that describe the items in the order you just placed. These messages were also posted by the **HandleOrders** Azure Function App.
32. On the **Adventure-Works** tab, place a few more orders. Notice how the details of the orders are processed by the HandleOrders function app, and the results displayed by the CustomerOrders and Warehouse apps.
33. When you have finished, close the Aventure-Works tab, but leave the **CustomerOrders**, and **Warehouse** apps running.

### Task 5: Observe the query overhead of using the change feed

1. In the left panel, click **All resources**, and then click **20777-mod7-sql-\<*your initials\>\<day*\>**.
2. On the **20777-mod7-sql-\<*your initials\>\<day*\>** blade, under **Monitoring**, click **Metrics**.
3. On the **Metrics** blade, on the **Throughput** tab, in the **Database(s)** drop-down list, click **Adventure-Works**.
4. In the **Collection(s)** drop-down list, click **Data**.
5. On the Start menu, click **Visual Studio 2017** to start another instance of Visual Studio 2017.
6. On the **File** menu, point to **Open**, and then click **Project/Solution**.
7. In the **Open Project** dialog box, go to **E:\\Labfiles\\Lab07\\Starter\\Exercise02\\PlaceOrders**, and then double-click **PlaceOrders.sln**.
8. In the **Security Warning for PlaceOrders** dialog box, clear the **Ask me for every project in this solution** check box, and then click **OK**.
9. In Solution Explorer, click **App.config**.
10. On the **App.config** tab, in the **appSettings** section, replace **\~URI\~** with the **URI**, and replace **\~KEY\~** with the **PRIMARY KEY** values that you noted earlier for the **20777-mod7-sql-\<*your initials\>\<day*\>** Cosmos DB account.
11. Press F5 to build and run the application. You will see messages indicating that orders are being created and added to the database.
12. Switch to the window displaying the ouput of the **CustomerOrders** app, and verify that you see new orders being processed.
13. Wait for 5 or 10 minutes while the PlaceOrders generates orders.

    > **Note**: The CustomerOrders app might display an exception ocassionally when it finds an unexpected character appearing in a message retrieved from the queue. You can ignore these exceptions.

14. Leave the PlaceOrders app running, and return to the Azure portal displaying the throughput for the Cosmos DB database.
15. Click **Refresh** to see the most recent statistics. Note that the updated statistics will not appear immediately, so you might need to wait for a couple more minutes and then click **Refresh** again.
16. Make a note of the **Number of requests (aggregated over a 1 minute interval)**.
17. In the left panel, click **All resources**, and then click **20777-func-\<*your initials*\>**.
18. In the **Message from webpage** dialog box, click **OK**.
19. On the **20777-func-\<*your initials*\>** blade, click **Stop** to halt the function app.
20. In the **Message from webpage** dialog box, click **OK**.
21. In the left panel, click **All resources**, and then click **20777-mod7-sql-\<*your initials\>\<day*\>**.
22. On the **20777-mod7-sql-\<*your initials\>\<day*\>** blade, under **Monitoring**, click **Metrics**.
23. On the **Metrics** blade, on the **Throughput** tab, in the **Database(s)** drop-down list, click **Adventure-Works**.
24. In the **Collection(s)** drop-down list, click **Data**.
25. Wait for a few minutes, and then periodically click **Refresh**. You should see that the number of requests aggregated over a 1 minute interval drops to less than half the previous value (the **PlaceOrders** app should still be running, but the **CustomerOrders** and **Warehouse** apps will appear to have stalled as no more messages are appearing on the ServiceBus queues). Although the function app was not performing any explicit queries, listening to the change feed adds significantly to the workload on the database. You should bear this overhead in mind when building your own applications that use the change feed of a collection.
26. Stop the **Warehouse**, **CustomerOrders**, and **PlaceOrders** apps, and close all instances of Visual Studio.

## Exercise 3: Displaying rolling revenue for a given time period

### Task 1: Create a Databricks notebook for calculating rolling revenue

> **Note**: The Scala code used in this task can be found in the file **E:\\Labfiles\\Lab07\\Solution\\Exercise03\\rollingrevenue.txt**.

1. In the Azure portal, in the left panel, click **All resources**, and then click **20777a-databricks-\<*your name\>-\<the day*\>**.
2. On the **20777a-databricks-\<*your name\>-\<the day*\>** blade, click **Launch Workspace**.
3. On the **Azure Databricks** page, under **Common Tasks**, click **New Notebook**.
4. In the **Create Notebook** dialog box, in the **Name** box, type **rollingrevenue**.
5. In the **Language** drop-down list, click **Scala**, and then click **Create**.
6. In the first cell of the notebook, type the following code:

    > **Note**: The code for the first few cells in the notebook is the same as the earlier exercise. This is because the notebook streams data from the change feed of the same collection.

    ```Scala
    // Import libraries required for streaming, and for the Cosmos DB connector

    import org.apache.spark.SparkConf
    import org.apache.spark.SparkContext
    import com.microsoft.azure.cosmosdb.spark.config.Config
    import com.microsoft.azure.cosmosdb.spark.schema._
    import com.microsoft.azure.cosmosdb.spark.streaming._
    import org.apache.spark.sql.functions._
    import java.sql.Timestamp
    ```

7. In the toolbar at the top right-hand side of the cell, on the **Edit Menu** menu, click **Add Cell Below**.
8.  In the new cell, type the following code. replace **--URI--** with the **URI**, and replace **--KEY--** with the **PRIMARY KEY** values that you noted earlier for the **20777-mod7-sql-\<*your initials\>\<day*\>** Cosmos DB account.

    ``` Scala
    // Configure the connection to the Cosmos DB database

    val databaseReadConfig = Map(
        "endpoint" -> "--URI--",
        "masterkey" -> "--KEY--",
        "database" -> "Adventure-Works",
        "collection" -> "Data",
        "readchangefeed" -> "true",
        "changefeedqueryname" -> "ordersquery",
        "changefeedstartfromthebeginning" -> "false",
        "samplingratio" -> "1.0",
        "schema_samplesize" -> "1000",
        "changefeedcheckpointlocation" -> "/checkpointlocation2"
    )
    ```

9.  In the toolbar at the top right-hand side of the cell, on the **Edit Menu** menu, click **Add Cell Below**.
10. In the new cell, type the following code:

    ```Scala
    // Specify that spark should stream data from the change feed

    val changeFeedStream = spark
        .readStream
        .format(classOf[CosmosDBSourceProvider].getName)
        .options(databaseReadConfig)
        .load()
    ```

11. In the toolbar at the top right-hand side of the cell, on the **Edit Menu** menu, click **Add Cell Below**.
12. In the new cell, type the following code:

    ```Scala
    // Filter out all documents that are not new orders

    val ordersStream = changeFeedStream.filter("doctype == 'ShoppingCartOrder' AND isshoppingcartororder == 'Order' AND orderstatus == 'In progress'")
    ```

13. In the toolbar at the top right-hand side of the cell, on the **Edit Menu** menu, click **Add Cell Below**.
14. In the new cell, type the following code:

    ```Scala
    // Extract the revenue details from the dataframe, and include the current time

    val revenueDetailsFrame = ordersStream
        .select($"totalcost", $"itemscost")
        .withColumn("now", current_timestamp)
    ```

15. In the toolbar at the top right-hand side of the cell, on the **Edit Menu** menu, click **Add Cell Below**.
16. In the new cell, type the following code:

    ```Scala
    // Calculate the rolling revenue for the 5 minutes, with a sliding window of 1 minute

    val revenuePerMinute = revenueDetailsFrame
        .withWatermark("now", "30 seconds")
        .groupBy(window($"now", "5 minutes", "1 minute").as("time"))
        .agg(sum($"totalcost").as("revenueperminute"), sum($"itemscost").as("revenueperminutebeforediscount"))
    ```

17. In the toolbar at the top right-hand side of the cell, on the **Edit Menu** menu, click **Add Cell Below**.
18. In the new cell, type the following code:

    ```Scala
    // Capture the rolliong revenue to a table in memory

    val query = revenuePerMinute
        .writeStream
        .format("memory")        // memory = store data in-memory in a table (only do this if the results of the streaming aggregation are low-volume)
        .queryName("revenue")    // revenue = name of the in-memory table
        .outputMode("append")  
        .start()
    ```

19. In the toolbar at the top right-hand side of the cell, on the **Edit Menu** menu, click **Add Cell Below**.
20. In the new cell, type the following code:

    ```Scala
    %sql
    select revenueperminute, revenueperminutebeforediscount, revenueperminutebeforediscount - revenueperminute as discounted, time.end as time 
    from revenue
    ```

### Task 2: Place orders and observe the rolling revenue

1. On the Start menu, click **Visual Studio 2017**.
2. On the **File** menu, point to **Open**, and then click **Project/Solution**.
3. In the **Open Project** dialog box, go to **E:\\Labfiles\\Lab07\\Starter\\Exercise03\\PlaceOrders**, and then double-click **PlaceOrders.sln**.
4. In the **Security Warning for PlaceOrders** dialog box, clear the **Ask me for every project in this solution** check box, and then click **OK**.
5. In Solution Explorer, click **App.config**.
6. On the **App.config** tab, replace **\~URI\~** with the **URI**, and replace **\~KEY\~** with the **PRIMARY KEY** values that you noted earlier for the **20777-mod7-sql-\<*your initials\>\<day*\>** Cosmos DB account.
7. Press F5 to build and run the application. You will initially see messages indicating that old orders are being deleted; this is simply to clear data out of the database.
8. At the prompt, press Enter to generate new orders. You will see messages indicating that new orders are being created.
9. Allow the app to run for a minute, and then return to the Databricks notebook (leave the app running).
10. In the toolbar at the top of the notebook, click **Detached**, and then click **\<*your name*\>-cluster**.
11. In the toolbar at the top of the notebook, click **Run All**. 
12. In the **This notebook is not attached to a cluster** dialog box, click **Start and Run**.
13. Wait for the penultimate cell in the notebook to indicate that it has started streaming data; the cell should run continuously, and you will see a **Last updated** message appear at regular intervals.
14. Allow the notebook to run for another minute.
15. In the final cell in the notebook, in the toolbar at the top right-hand side, on the **Run Cell** menu, click **Run Cell**. A table displaying data for the last few minutes (1 row per minute) should appear. The figures in the **revenueperminute** and **revenueperminutebeforediscount** columns show the rolling revenue for the 5 minutes that end in the **time** column.
16. Below the table, click the graph drop-down arrow, and then click **Line (deprecated)**.
17. Click **Plot Options**.
18. In the **Customize Plot** dialog box, delete all columns from the **Keys**, **Series groupings**, and **Values** boxes.
19. In the **All fields** box, click the **time** column and drag it into the **Keys** box.
20. In the **All fields** box, click the **revenueperminute** column and drag it into the **Values** box.
21. In the **All fields** box, click the **revenueperminutebeforediscount** column and drag it into the **Values** box.
22. In the **All fields** box, click the **discounted** column and drag it into the **Values** box.
23. Click **Apply**. The table in the notebook should be replaced with a graph depicting the rolling revenue values.
24. In the toolbar at the top right-hand side of the cell, on the **Run Cell** menu, click **Run Cell**. The graph should be updated with the latest values. 
25. Wait for another minute and run the cell again. Repeat this process for 5 minutes. At this point, the data in the graph should start to level off. This is because for the first four minutes, the number of orders in the database is starting from a low point (no orders). After 5 minutes, the number of orders in the preceding 5 minute window should be reasonably constant, and the rolling revenue should also tend to even out.
26. In the toolbar at the top of the notebook, click **Stop Execution**.
27. Close the **Azure Databricks** portal.
28. In Visual Studio 2017, on the **Debug** menu, click **Stop Debugging**.
29. Close **Visual Studio 2017**.

## Exercise 4: Handling product deliveries

### Task 1: Create an Azure IoT Hub

1. In the Azure portal, in the left panel, click **+ Create a Resource**.
2. On the **New** blade, in the search box, type **IoT**, and then press Enter.
3. On the **Everything** blade, click **IoT Hub**, and then click **Create**.
4. On the **IoT hub** blade, on the **Basics** tab, in the **Resource Group** drop-down list, click **20777Mod07**.
5. In the **Region** drop-down list, click the region closest to your current location.
6. In the **IoT Hub Name** box, type **20777a-iothub-\<*your name\>-\<the day*\>**, and then click **Next: Size and scale**.
7. On the **Size and scale** tab, in the **Pricing and scale tier** drop-down list, click **B1: Basic tier**. 
8. Leave the remaining settings at their default values, and then click **Review + create**.
9. On the **Review + create** tab, click **Create**.
10. Wait while the IoT hub is created and deployed.
11. In the Azure portal, in the left panel, click **All resources**, and then click **20777a-iothub-\<*your name\>-\<the day*\>**.
12. On the **20777a-iothub-\<*your name\>-\<the day*\>** blade, under **Settings**, click **Shared access policies**, and then click **device**.
13. Make a note of the **Connection string-primary key** value.
14. Close the **device** blade.
15. On the **20777a-iothub-\<*your name\>-\<the day*\>** blade, under **Explorers**, click **IoT devices**, and then click **+ Add**.
16. On the **Create a device** blade, in the **Device ID** box, type **Scanner**.
17. Leave the other settings as their default values, and then click **Save**.

### Task 2: Create an Azure Stream Analytics Job

1. In the left panel, click **+ Create a resource**.
2. On the **New** blade, in the search box, type **Stream**, and then press Enter.
3. On the **Everything** blade, click **Stream Analytics job**, and then click **Create**.
4. On the **New Stream Analytics job** blade, in the **Job name** box, type **20777a-job-\<*your name\>-\<the day*\>**.
5. In the **Resource group** drop-down list, click **20777Mod07**.
6. In the **Location** drop-down list, click the location closest to your current location.
7. Set **Streaming units** to **6**, and then click **Create**.
8. Wait while the stream analytics job is created.

### Task 3: Create a Cosmos DB collection for holding the details of product deliveries

1. In the Azure portal, in the left panel, click **All resources**, and then click **20777-mod7-sql-\<*your initials\>\<day*\>**.
2. On the **20777-mod7-sql-\<*your initials\>\<day*\>** blade, click **Data Explorer**, right-click **Adventure-Works**, and then click **New Collection**.
3. On the **Add Collection** blade, in the **Collection Id** box, type **Deliveries**.
4. In the **Partition key** box, type **/productnumber**, and then click **OK**.

### Task 4: Connect the IoT Hub, Stream Analytics Job, and Cosmos DB Database

1. In the left panel, click **All resources**, and then click **20777a-job-\<*your name\>-\<the day*\>**.
2. On the **20777a-job-\<*your name\>-\<the day*\>** blade, under **Job topology**, click **Inputs**, click **+ Add stream input**, and then click **IoT Hub**.
3. On the **IoT Hub** blade, in the **Input alias** box, type **ScannerDevicesHub**.
4. In the **Shared access policy name** drop-down list, click **service**.
5. Leave the remaining fields at their default values, and then click **Save**.
6. On the **20777a-job-\<*your name\>-\<the day*\>** blade, under **Job topology**, click **Outputs**, click **+ Add**, and then click **Cosmos DB**.
7. On the **Cosmos DB** blade, in the **Output alias** box, type **AdventureWorks**.
8. Select the **Provide Cosmos DB settings manually** check box.
9. In the **Account id** box, type **20777-mod7-sql-\<*your initials\>\<day*\>**.
10. In the **Account Key** box, enter the **PRIMARY KEY** for your **20777-mod7-sql-\<*your initials\>\<day*\>** Cosmos DB account.
11. In the **Database** box, type **Adventure-Works**.
12. In the **Collection name pattern** box, type **Deliveries**.
13. In the **Document id** box, type **id**, and then click **Save**.
14. Wait while the connection to the output is verified and validated.
15. On the **20777a-job-\<*your name\>-\<the day*\>** blade, under **Job topology**, click **Query**.
16. On the **Query** blade, replace the existing query with the following query, and then click **Save**.

    ```SQL
    SELECT
        id, productnumber, volumedelivered, time
    INTO
        AdventureWorks
    FROM
        ScannerDevicesHub
    ```

17. In the **Save** dialog box, click **Yes**.


### Task 5: Create the ProcessDeliveries function

> **Note**: The complete code for the **ProcessDeliveries** function is available in the file **E:\\Labfiles\\Lab07\\Solution\\Exercise04\\ProcessDeliveries.txt**.

1. In the Azure portal, in the left panel, click **All resources**, and then click **20777-func-\<*your name\>-\<the day*\>**.
2. On the **20777-func-\<*your name\>-\<the day*\>** blade, on the **Overview** tab, if the status of the app is **Stopped**, click **Start**, and wait until the **Status** is set to **Running**.
3. Click **Functions**, and then click **+ New function**.
4. On the **Choose a template below or go to the quickstart** blade, click **Azure Cosmos DB trigger**.
5. On the **New Function** blade, in the **Name** box, type **ProcessDelivieries**.
6. Under **Azure Cosmos DB trigger**, accept the existing **Azure Cosmos DB account connection** configuration.
7. In the **Collection name** box, type **Deliveries**.
8. Select the **Create lease collection if it does not exist** check box.
9. In the **Database name** box, type **Adventure-Works**.
10. Leave **Collection name for leases** set to **leases**, and then click **Create**.
11. In the **Function Apps** pane, click **20777-func-\<*your name\>-\<the day*\>**, and then click **Overview**.
12. Under **Configured features**, click **Application settings**.
13. On the **Application settings** tab, in the **Application settings** section, click **+ Add new setting**.
14. In the **APP SETTING NAME** box, type **EndpointUrl**.
15. In the **VALUE** box, type the **URI** of your **20777-mod7-sql-\<*your initials\>\<day*\>** Cosmos DB account.
16. Click **+ Add new setting**.
17. In the **APP SETTING NAME** box, type **PrimaryKey**.
18. In the **VALUE** box, type the **PRIMARY KEY** of your **20777-mod7-sql-\<*your initials\>\<day*\>** Cosmos DB account.
19. Click **+ Add new setting**.
20. In the **APP SETTING NAME** box, type **Database**.
21. In the **VALUE** box, type **Adventure-Works**.
22. Click **+ Add new setting**.
23. In the **APP SETTING NAME** box, type **Collection**.
24. In the **VALUE** box, type **Data**, and then click **Save**.
25. In the **Function Apps** pane, click the **ProcessDeliveries** function.
26. On the **run.csx** blade, at the top of the file, under the reference to the **Microsoft.Azure.DocumentDB.Core** assembly, add a reference to the **Newtonsoft.Json** assembly, as shown by the following code:

    ```CSharp
    #r "Newtonsoft.Json"
    ```

27. Add the following **Using** directive to those already in the script:

    ```CSharp
    using Microsoft.Azure.Documents.Client;
    using System.Net;
    using Newtonsoft.Json;
    ```

28. After the closing brace of the **Run** function, add the following class definitions to the file:

    ```CSharp
    // Document types representing delivery records and products
    class ProductDeliveryRecord: Document
    {
        [JsonProperty("id")]
        public string ID { get; set; }

        [JsonProperty("productnumber")]
        public string ProductNumber { get; set; }

        [JsonProperty("volumedelivered")]
        public int Volume { get; set; }

        [JsonProperty("time")]
        public DateTime Time { get; set; }

        public override string ToString()
        {
            return $"Product: {ProductNumber}, Volume: {Volume}, Time: {Time}";
        }
    }

    public abstract class DocumentType: Document
    {
        [JsonProperty("doctype")]
        public string DocType { get; set; }

        public DocumentType()
        {
            this.DocType = this.GetType().Name;
        }
    }

    public class ProductCategoryData : DocumentType
    {
        [JsonProperty("partitionkey")]
        public string Subcategory { get; set; }

        [JsonProperty("category")]
        public string Category { get; set; }
    }

    public class ProductDocumentData
    {
        [JsonProperty("documenttitle")]
        public string DocumentTitle { get; set; }

        [JsonProperty("documentsummary")]
        public string DocumentSummary { get; set; }

        [JsonProperty("document")]
        public string Document { get; set; }
    }

    public class ProductImageData
    {
        [JsonProperty("diagram")]
        public string Diagram { get; set; }

        [JsonProperty("thumbnail")]
        public string Thumbnail { get; set; }

        [JsonProperty("largephoto")]
        public string LargePhoto { get; set; }
    }

    public class Product : DocumentType
    {
        [JsonProperty("id")]
        public string ProductID { get; set; }

        [JsonProperty("partitionkey")]
        public string Subcategory { get; set; }

        [JsonProperty("productcategory")]
        public string Category { get; set; }

        [JsonProperty("productname")]
        public string ProductName { get; set; }

        [JsonProperty("productnumber")]
        public string ProductNumber { get; set; }

        [JsonProperty("color")]
        public string Color { get; set; }

        [JsonProperty("listprice")]
        public decimal ListPrice { get; set; }

        [JsonProperty("size")]
        public string Size { get; set; }

        [JsonProperty("weight")]
        public string Weight { get; set; }

        [JsonProperty("quantityinstock")]
        public int QuantityInStock { get; set; }

        [JsonProperty("model")]
        public string Model { get; set; }

        [JsonProperty("description")]
        public string Description { get; set; }

        [JsonProperty("documentation")]
        public ProductDocumentData Documentation { get; set; }

        [JsonProperty("images")]
        public ProductImageData Images { get; set; }
    }
    ```

29. Modify the definition of the **Run** method to indicate that it supports asynchronous operations.

    ```CSharp
    public static async Task Run(IReadOnlyList<Document> input, ILogger log)
    ```

30. Remove the following two statements from the body of the function:

    ```CSharp
    log.LogInformation("Documents modified " + input.Count);
    log.LogInformation("First document Id " + input[0].Id);
    ```

31. Inside the **if** statement, add the following lines of code that retrieve the configuration settings required to connect to the Data collection in the **Adventure-Works** database, and then use these settings to create a DocumentClient object:

    > **Note**: Application settings are exposed as environment variables rather than configuration settings.

    ```CSharp
    string endpointUrl = System.Environment.GetEnvironmentVariable("EndpointUrl", EnvironmentVariableTarget.Process);
    string primaryKey = System.Environment.GetEnvironmentVariable("PrimaryKey", EnvironmentVariableTarget.Process);
    string database = System.Environment.GetEnvironmentVariable("Database", EnvironmentVariableTarget.Process);
    string collection = System.Environment.GetEnvironmentVariable("Collection", EnvironmentVariableTarget.Process);

    var client = new DocumentClient(new Uri(endpointUrl), primaryKey);
    ```

32. Inside the **if** statement, add the following statements:

    ```CSharp
    // Iterate through the change feed
    foreach (Document doc in input)
    {

    }
    ```

33. Inside the **foreach** block, add the following code:

    ```CSharp
    // Deserialize each document - it should be a ProductDeliveryRecord
    ProductDeliveryRecord deliveryDoc = JsonConvert.DeserializeObject<ProductDeliveryRecord>(doc.ToString());

    // Display the details on the trace log
    log.LogInformation(deliveryDoc.ToString());
    ```
34. Still inside the **foreach** block, immediately after the code you have just entered, add the following statements:

    ```CSharp
    // Update the volume in stock in the Data collection in the Adventure-Works database
    var dataCollectionUri = UriFactory.CreateDocumentCollectionUri(database, collection);
    var productQueryText = "SELECT * FROM c WHERE c.doctype = 'Product' AND c.productnumber = @productnum";
    Product productDoc;
    ```

35. Add the following code after the statements that you entered in the previous step. This code runs the query that fetches the corresponding product from the **Data** collection, and then updates the **QuantityInStock** field with the value from the new delivery. The **SaveDocument** function attempts to write the updated product document back to the **Data** collection. The **SaveDocument** returns a boolean that indicates whether the save operation was successful; while customers are placing orders, the stock levels are updated, and it is important not to lose these changes. The **SaveDocument** method uses ETags to prevent this situation from occuring. The *do* loop iterates, repeatedly fetching the latest version of the product document and attempting to save it until the operation is successful.

    ```CSharp
    do
    {
        // Find the product in the Data collection
        var productParam = new SqlParameterCollection { 
            new SqlParameter("@productnum", deliveryDoc.ProductNumber)
        };

        var productQuery = client.CreateDocumentQuery(dataCollectionUri, new SqlQuerySpec
        {
            QueryText = productQueryText,
            Parameters = productParam
        }, new FeedOptions
        {
            EnableCrossPartitionQuery = true
        }).AsEnumerable();

        productDoc = productQuery.Take(1).Single();
        log.LogInformation($"product is {productDoc.ProductName}"); 

        // Update the quantityinstock field of the product doc to reflect the new delivery
        productDoc.QuantityInStock += deliveryDoc.Volume;
    }
    // Save the updated product doc back to the database.
    // If the Save operation fails, it could be due to a conflict caused by a simultaneous update such as a customer placing an order.
    // If so, try querying the product to get the most up to date information and save it again
    while(! await SaveDocument(productDoc, client, log));
    ```

36. After the closing brace of the **Run** method, but above the definition of the **ProductDeliveryRecord** class, add the following function. This function saves the document, using the ETag to ensure that the document has not been modified by another user since it was retrieved.

    ```CSharp
    // Save a document and check for conflicts by using the ETag
    // Return true if the update was successful, false otherwise
    private static async Task<bool> SaveDocument(Document doc, DocumentClient client, ILogger log)
    {
        try
        {
            // Replace the document in the database with the updated doc
            RequestOptions options = new RequestOptions
            {
                AccessCondition = new AccessCondition
                {
                    Condition = doc.ETag,
                    Type = AccessConditionType.IfMatch
                }
            };

            var response = await client.ReplaceDocumentAsync(doc.SelfLink, doc, options);
            log.LogInformation($"Document replaced. Status code is {response.StatusCode}");
            return true;
        }
        catch (DocumentClientException dce)
        {
            // If a conflict occured, display a message
            if (dce.StatusCode == HttpStatusCode.PreconditionFailed)
            {
                log.LogInformation("Update failed - another user already changed this document. Requery and try again");
            }
            return false;
        }
    }
    ```

37. Click **Save**.

### Task 6: Simulate deliveries arriving at the warehouse

1. In the left panel, click **All resources**, and then click **20777a-job-\<*your name\>-\<the day*\>**.
2. On the **20777a-job-\<*your name\>-\<the day*\>** blade, click **Overview**, and then click **Start**.
3. On the **Start job** blade, click **Start**. Wait for the stream analytics job to start before continuing.
4. On the Windows Start menu, click **Visual Studio 2017**.
5. On the **File** menu, point to **Open**, and then click **Project/Solution**.
6. In the **Open Project** dialog box, go to **E:\\Labfiles\\Lab07\\Starter\\Exercise04\\ProductScanner**, and then double-click **ProductScanner.sln**.
7. In the **Security Warning for PlaceOrders** dialog box, clear the **Ask me for every project in this solution** check box, and then click **OK**.
8. In Solution Explorer, click **App.config**.
9. On the **App.config** tab, in the **appSettings** section, replace **\~CONNECTION STRING\~** with the **Connection string-primary key** values that you noted earlier for the **20777a-iothub-\<*your name\>-\<the day*\>**.
10. Press F5 to build and run the application. You should see messages appearing at 5 second intervals representing new deliveries.
11. Return to the Azure portal, click **All resources**, and then click **20777-mod7-sql-\<*your initials\>\<day*\>**, and then click **Data Explorer**.
12. In the **SQL API** pane, expand **Adventure-Works**, expand **Deliveries**, and then click **Documents**. Verify that some delivery documents have been created. These documents have been added by the Azure Stream Analytics job, using the data streamed from the IoT Hub.
13. Click any document and examine its contents. It should look similar to this:

    ```JSON
    {
       "id": "24037fa0-06b9-404a-912d-017464462f63",
        "productnumber": "TO-2301",
        "volumedelivered": 99,
        "time": "2018-08-22T12:28:07.2210179Z",
        "_rid": "T3ILALIG40ATAAAAAAAAAA==",
        "_self": "dbs/T3ILAA==/colls/T3ILALIG40A=/docs/T3ILALIG40ATAAAAAAAAAA==/",
        "_etag": "\"01008a9e-0000-0000-0000-5b7d56dc0000\"",
        "_attachments": "attachments/",
        "_ts": 1534940892
    }
    ```

14. In the left panel, click **All resources**, and then click **20777a-func-\<your name\>-\<the day\>**.
15. Click the **ProcessDeliveries** function, and then click **Logs**. You should see log messages (similar to those below) appearing as the documents are added to the **Deliveries** collection and are processed by the function.

    ```Text
    2018-10-11T09:56:22.850 [Information] Executing 'Functions.ProcessDelivieries' (Reason='New changes on collection Deliveries at 2018-10-11T09:56:22.8492213Z', Id=0b26834f-24a3-4878-99e4-56ae95a4f93c)
    2018-10-11T09:56:22.899 [Information] Product: BK-M18S-48, Volume: 83, Time: 10/11/2018 9:56:15 AM
    2018-10-11T09:56:24.257 [Information] product is Mountain-500 Silver, 48
    2018-10-11T09:56:24.380 [Information] Document replaced. Status code is OK
    2018-10-11T09:56:24.380 [Information] Executed 'Functions.ProcessDelivieries' (Succeeded, Id=0b26834f-24a3-4878-99e4-56ae95a4f93c)
    ```

### Task 7: Clean up the lab environment

1. In Visual Studio 2017, on the **Debug** menu, click **Stop Debugging**.
2. Close Visual Studio.
3. In Internet Explorer, in the left panel, click **Resource groups**.
4. On the **Resource groups** blade, right-click  **20777Mod07**, and then click **Delete resource group**.
5. On the **Are you sure you want to delete "20777Mod07"?** blade, in the **TYPE THE RESOURCE GROUP NAME** box, type **20777Mod07**, and then click **Delete**.

---
© 2018 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode), additional terms may apply. All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant. This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided "as-is." Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.
